{% extends "base.html" %}
{% load static %}
{% load metadata_manager_filters %}

{% block title %}DataHub Glossary{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    .description-cell {
        max-width: 300px;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .description-preview {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: 4.2em; /* 3 lines * 1.4 line-height */
    }
    
    .related-items-cell {
        max-width: 250px;
    }
    
    .relationship-badge {
        font-size: 0.7rem;
        margin: 0.1rem;
        padding: 0.2rem 0.4rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    .type-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tab-loading {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    
    .table-responsive {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
    
    /* Modal enhancements */
    .modal-body dl {
        margin-bottom: 0;
    }
    
    .modal-body dt {
        font-weight: 600;
        color: #495057;
        margin-top: 1rem;
    }
    
    .modal-body dt:first-child {
        margin-top: 0;
    }
    
    .modal-body dd {
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
    
    .relationship-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        padding: 0.25rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    
    .owner-item {
        display: inline-block;
        margin: 0.1rem;
        padding: 0.2rem 0.5rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    
    /* Interactive hierarchy styles */
    .hierarchy-container {
        display: flex;
        align-items: center;
        position: relative;
        min-height: 20px;
    }
    
    .tree-connector {
        position: relative;
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        margin-right: 2px;
    }
    
    .tree-connector::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        width: 1px;
        height: 100%;
        background-color: #dee2e6;
    }
    
    .tree-connector::after {
        content: '';
        position: absolute;
        left: 10px;
        top: 10px;
        width: 10px;
        height: 1px;
        background-color: #dee2e6;
    }
    
    /* Hide vertical line for last items in a group */
    .tree-connector.last-child::before {
        height: 10px;
    }
    
    /* Hide connectors for root level */
    tr[data-level="0"] .tree-connector {
        display: none;
    }
    
    .expand-button-container {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 4px;
    }
    
    /* Expand/collapse button styling */
    .expand-icon {
        width: 12px;
        height: 12px;
        font-size: 10px;
        transition: transform 0.2s ease;
        cursor: pointer;
    }
    
    .btn-link:hover .expand-icon {
        color: #007bff !important;
        transform: scale(1.1);
    }
    
    .expand-button {
        border: none;
        background: none;
        padding: 1px;
        line-height: 1;
        color: #6c757d;
        cursor: pointer;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 2px;
    }
    
    .expand-button:hover {
        color: #007bff;
        background-color: #f8f9fa;
    }
    
    /* Item name styling */
    .item-name {
        font-weight: 500;
        margin-left: 2px;
        flex-grow: 1;
    }
    
    /* Smooth transitions for expand/collapse */
    tbody tr {
        transition: opacity 0.15s ease;
    }
    
    /* Better visual spacing */
    .table td {
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
    }
    
    /* Ensure consistent alignment */
    .name-cell {
        position: relative;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>DataHub Glossary</h1>
        <div>
            <a href="{% url 'metadata_manager:glossary_node_create' %}" class="btn btn-primary">
                <i class="fas fa-folder-plus me-1"></i> Create Node
            </a>
            <a href="{% url 'metadata_manager:glossary_term_create' %}" class="btn btn-success ms-2">
                <i class="fas fa-tag me-1"></i> Create Term
            </a>
            <div class="dropdown d-inline-block ms-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="batchActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-tasks me-1"></i> Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="batchActionsDropdown">
                    <li><h6 class="dropdown-header">Selected Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-selected-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push to DataHub
                    </button></li>
                    <li><button type="button" class="dropdown-item" id="download-selected-items">
                        <i class="fas fa-download me-1"></i> Download Selected
                    </button></li>
                    {% if has_git_integration %}
                    <li><button type="button" class="dropdown-item" id="add-selected-to-git">
                        <i class="fab fa-github me-1"></i> Add to GitHub PR
                    </button></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">All Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-all-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push All
                    </button></li>
                    <li><a href="{% url 'metadata_manager:glossary_pull' %}" class="dropdown-item">
                        <i class="fas fa-cloud-download-alt me-1"></i> Pull from DataHub
                    </a></li>
                    <li><a href="{% url 'metadata_manager:glossary_import_export' %}" class="dropdown-item">
                        <i class="fas fa-file-export me-1"></i> Import/Export
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
            
    {% if not has_datahub_connection %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-1"></i> Not connected to DataHub. Please check your connection settings.
    </div>
    {% endif %}
            
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="glossaryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-content" 
                   type="button" role="tab" aria-controls="local-content" aria-selected="true">
                <i class="fas fa-laptop me-1"></i> 
                Local 
                <span class="badge bg-secondary ms-1" id="local-badge">{{ local_count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote-content" 
                   type="button" role="tab" aria-controls="remote-content" aria-selected="false">
                <i class="fas fa-cloud me-1"></i> 
                Remote 
                <span class="badge bg-info ms-1" id="remote-badge">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="synced-tab" data-bs-toggle="tab" data-bs-target="#synced-content" 
                   type="button" role="tab" aria-controls="synced-content" aria-selected="false">
                <i class="fas fa-sync me-1"></i> 
                Synced 
                <span class="badge bg-success ms-1" id="synced-badge">{{ synced_count }}</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="glossaryTabsContent">
        <!-- Local Tab -->
        <div class="tab-pane fade show active" id="local-content" role="tabpanel" aria-labelledby="local-tab">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Local Glossary Items</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="local-table" class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="4%">
                                        <input type="checkbox" id="local-select-all">
                                    </th>
                                    <th width="6%">Type</th>
                                    <th width="28%">Name</th>
                                    <th width="30%">Description</th>
                                    <th width="18%">Related Items</th>
                                    <th width="8%">Status</th>
                                    <th width="6%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="local-table-body">
                                <!-- Local data will be populated here -->
                                {% include 'metadata_manager/glossary/partials/local_table_rows.html' %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Remote Tab -->
        <div class="tab-pane fade" id="remote-content" role="tabpanel" aria-labelledby="remote-tab">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Remote Glossary Items</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-remote-data" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-sync"></i> Refresh
                            </button>
                </div>
                <div class="card-body p-0">
                    <div id="remote-table-container">
                        <div class="tab-loading">
                            <div class="loading-spinner me-2"></div>
                            Loading remote glossary data...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Synced Tab -->
        <div class="tab-pane fade" id="synced-content" role="tabpanel" aria-labelledby="synced-tab">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Synced Glossary Items</h5>
                </div>
                <div class="card-body p-0">
                    <div id="synced-table-container">
                        <div class="tab-loading">
                            <div class="loading-spinner me-2"></div>
                            Loading synced glossary data...
                                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="modalActions">
                    <!-- Action buttons will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let remoteDataLoaded = false;
let syncedDataLoaded = false;

function loadRemoteData() {
    const container = document.getElementById('remote-table-container');
    if (!container) {
        return;
    }
    
    container.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div> Loading remote data...</div>';
    
    fetch('/metadata/glossary/data/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateRemoteTable(data.data);
                remoteDataLoaded = true;
                
                // Update tab badge
                const allItems = [...(data.data.remote_only_nodes || []), ...(data.data.remote_only_terms || [])];
                const badge = document.getElementById('remote-badge');
                if (badge) badge.textContent = allItems.length;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Failed to load remote data</div>';
            }
        })
        .catch(error => {
            container.innerHTML = '<div class="alert alert-danger">Error loading remote data</div>';
        });
}

function loadSyncedData() {
    const container = document.getElementById('synced-table-container');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div> Loading synced data...</div>';
    
    fetch('/metadata/glossary/data/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateSyncedTable(data.data);
                syncedDataLoaded = true;
                
                // Update tab badge
                const allItems = [...(data.data.synced_nodes || []), ...(data.data.synced_terms || [])];
                const badge = document.getElementById('synced-badge');
                if (badge) badge.textContent = allItems.length;
            } else {
                container.innerHTML = '<div class="alert alert-danger">Failed to load synced data</div>';
            }
        })
        .catch(error => {
            container.innerHTML = '<div class="alert alert-danger">Error loading synced data</div>';
        });
}

function populateSyncedTable(data) {
    const allItems = [...(data.synced_nodes || []), ...(data.synced_terms || [])];
    
    // Build hierarchical structure
    const hierarchy = buildHierarchy(allItems);
    
    const tableHtml = `
        <div class="table-responsive">
            <table id="synced-table" class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="4%">
                            <input type="checkbox" id="synced-select-all">
                        </th>
                        <th width="6%">Type</th>
                        <th width="28%">Name</th>
                        <th width="30%">Description</th>
                        <th width="18%">Related Items</th>
                        <th width="8%">Status</th>
                        <th width="6%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${renderHierarchicalRows(hierarchy, 0, null, 'synced')}
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('synced-table-container').innerHTML = tableHtml;
    
    // Initialize DataTable if jQuery is available
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        try {
            $('#synced-table').DataTable({
                pageLength: 25,
                responsive: true,
                order: [[2, 'asc']],
                columnDefs: [
                    { orderable: false, targets: [0, 6] },
                    { width: "4%", targets: 0 },
                    { width: "6%", targets: 1 },
                    { width: "28%", targets: 2 },
                    { width: "30%", targets: 3 },
                    { width: "18%", targets: 4 },
                    { width: "8%", targets: 5 },
                    { width: "6%", targets: 6 }
                ]
            });
        } catch (e) {
            // DataTable initialization failed silently
        }
    }
}

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Tab event handling
    const remoteTab = document.getElementById('remote-tab');
    const syncedTab = document.getElementById('synced-tab');
    
    if (remoteTab) {
        // Primary approach: click event
        remoteTab.addEventListener('click', function(e) {
            setTimeout(function() {
                if (!remoteDataLoaded) {
                    loadRemoteData();
                }
            }, 100);
        });
        
        // Secondary approach: Bootstrap tab event
        remoteTab.addEventListener('shown.bs.tab', function(e) {
            if (!remoteDataLoaded) {
                loadRemoteData();
            }
        });
    }
    
    if (syncedTab) {
        syncedTab.addEventListener('click', function(e) {
            setTimeout(function() {
                if (!syncedDataLoaded) {
                    loadSyncedData();
                }
            }, 100);
        });
        
        syncedTab.addEventListener('shown.bs.tab', function(e) {
            if (!syncedDataLoaded) {
                loadSyncedData();
            }
        });
    }
    
    // Initialize local table with DataTables if available
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        try {
            $('#local-table').DataTable({
                pageLength: 25,
                responsive: true,
                order: [[2, 'asc']],
                columnDefs: [
                    { orderable: false, targets: [0, 6] },
                    { width: "4%", targets: 0 },
                    { width: "6%", targets: 1 },
                    { width: "28%", targets: 2 },
                    { width: "30%", targets: 3 },
                    { width: "18%", targets: 4 },
                    { width: "8%", targets: 5 },
                    { width: "6%", targets: 6 }
                ]
            });
        } catch (e) {
            // DataTable initialization failed silently
        }
    }
    
    // Refresh button
    const refreshButton = document.getElementById('refresh-remote-data');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            remoteDataLoaded = false;
            syncedDataLoaded = false;
            loadRemoteData();
        });
    }
});

// Interactive hierarchy functions
function toggleNodeExpansion(nodeId, element) {
    const childRows = document.querySelectorAll(`tr[data-parent-id="${nodeId}"]`);
    const icon = element.querySelector('.expand-icon');
    const isExpanded = icon.classList.contains('fa-minus');
    
    childRows.forEach(row => {
        if (isExpanded) {
            // Collapse
            row.style.display = 'none';
            // Also collapse nested children
            const rowNodeId = row.getAttribute('data-node-id');
            if (rowNodeId) {
                collapseAllChildren(rowNodeId);
            }
        } else {
            // Expand
            row.style.display = '';
        }
    });
    
    // Toggle icon
    if (isExpanded) {
        icon.classList.remove('fa-minus');
        icon.classList.add('fa-plus');
    } else {
        icon.classList.remove('fa-plus');
        icon.classList.add('fa-minus');
    }
}

function collapseAllChildren(parentId) {
    const childRows = document.querySelectorAll(`tr[data-parent-id="${parentId}"]`);
    childRows.forEach(row => {
        row.style.display = 'none';
        const expandIcon = row.querySelector('.expand-icon');
        if (expandIcon) {
            expandIcon.classList.remove('fa-minus');
            expandIcon.classList.add('fa-plus');
        }
        // Recursively collapse children
        const rowNodeId = row.getAttribute('data-node-id');
        if (rowNodeId) {
            collapseAllChildren(rowNodeId);
        }
    });
}
</script>

<script>
// Keep remaining functions for compatibility
function populateRemoteTable(data) {
    const allItems = [...(data.remote_only_nodes || []), ...(data.remote_only_terms || [])];
    
    // Build hierarchical structure
    const hierarchy = buildHierarchy(allItems);
    
    const tableHtml = `
        <div class="table-responsive">
            <table id="remote-table" class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="4%">
                            <input type="checkbox" id="remote-select-all">
                        </th>
                        <th width="6%">Type</th>
                        <th width="28%">Name</th>
                        <th width="30%">Description</th>
                        <th width="18%">Related Items</th>
                        <th width="8%">Status</th>
                        <th width="6%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${renderHierarchicalRows(hierarchy, 0, null, 'remote')}
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('remote-table-container').innerHTML = tableHtml;
    
    // Initialize DataTable if jQuery is available
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        try {
            $('#remote-table').DataTable({
                pageLength: 25,
                responsive: true,
                order: [[2, 'asc']],
                columnDefs: [
                    { orderable: false, targets: [0, 6] },
                    { width: "4%", targets: 0 },
                    { width: "6%", targets: 1 },
                    { width: "28%", targets: 2 },
                    { width: "30%", targets: 3 },
                    { width: "18%", targets: 4 },
                    { width: "8%", targets: 5 },
                    { width: "6%", targets: 6 }
                ]
            });
        } catch (e) {
            // DataTable initialization failed silently
        }
    }
}

function buildHierarchy(items) {
    // Separate nodes and terms
    const nodes = items.filter(item => !item.parent_node_urn);
    const terms = items.filter(item => item.parent_node_urn);
    
    // Create hierarchy with nodes as parents
    const hierarchy = [];
    
    // Add root nodes
    const rootNodes = nodes.filter(node => !node.parent_urn);
    rootNodes.forEach(node => {
        const hierarchyNode = {
            item: node,
            children: [],
            level: 0
        };
        
        // Add child nodes
        const childNodes = nodes.filter(child => child.parent_urn === node.urn);
        childNodes.forEach(childNode => {
            hierarchyNode.children.push({
                item: childNode,
                children: getChildrenRecursive(childNode, nodes, terms, 1),
                level: 1
            });
        });
        
        // Add terms directly under this node
        const nodeTerms = terms.filter(term => term.parent_node_urn === node.urn);
        nodeTerms.forEach(term => {
            hierarchyNode.children.push({
                item: term,
                children: [],
                level: 1
            });
        });
        
        hierarchy.push(hierarchyNode);
    });
    
    // Add orphaned items (those without clear parents)
    const orphanedTerms = terms.filter(term => 
        !nodes.some(node => node.urn === term.parent_node_urn)
    );
    orphanedTerms.forEach(term => {
        hierarchy.push({
            item: term,
            children: [],
            level: 0
        });
    });
    
    return hierarchy;
}

function getChildrenRecursive(parent, allNodes, allTerms, level) {
    const children = [];
    
    // Add child nodes
    const childNodes = allNodes.filter(node => node.parent_urn === parent.urn);
    childNodes.forEach(child => {
        children.push({
            item: child,
            children: getChildrenRecursive(child, allNodes, allTerms, level + 1),
            level: level
        });
    });
    
    // Add terms under this node
    const nodeTerms = allTerms.filter(term => term.parent_node_urn === parent.urn);
    nodeTerms.forEach(term => {
        children.push({
            item: term,
            children: [],
            level: level
        });
    });
    
    return children;
}

function renderHierarchicalRows(hierarchy, startLevel, parentId = null, source) {
    let html = '';
    
    hierarchy.forEach(node => {
        const itemId = node.item.urn.replace(/[^a-zA-Z0-9]/g, '_');
        const hasChildren = node.children && node.children.length > 0;
        
        html += createTableRow(node.item, source, node.level, parentId, hasChildren);
        
        // Recursively render children
        if (hasChildren) {
            html += renderHierarchicalRows(node.children, node.level + 1, itemId, source);
        }
    });
    
    return html;
}

function createTableRow(item, source, level = 0, parentId = null, hasChildren = false) {
    const itemType = item.parent_node_urn !== undefined ? 'term' : 'node';
    const typeIcon = itemType === 'node' ? 'fas fa-folder text-warning' : 'fas fa-tag text-info';
    const typeBadge = itemType === 'node' ? 'Node' : 'Term';
    
    // Create unique ID for this item
    const itemId = item.urn.replace(/[^a-zA-Z0-9]/g, '_');
    
    // Create tree connectors for each level
    let treeConnectors = '';
    for (let i = 0; i < level; i++) {
        treeConnectors += '<div class="tree-connector"></div>';
    }
    
    // Create expand/collapse button for nodes with children
    const expandButton = hasChildren ? 
        `<div class="expand-button-container">
            <button class="expand-button" onclick="toggleNodeExpansion('${itemId}', this)">
                <i class="expand-icon fas fa-plus"></i>
            </button>
        </div>` : 
        `<div class="expand-button-container"></div>`; // Empty spacer for alignment
    
    // Truncate description at 100 characters but allow multiple lines
    const fullDescription = item.description || '';
    const truncatedDescription = fullDescription.length > 100 ? 
        fullDescription.substring(0, 100) + '...' : fullDescription;
    
    // Format related items
    const relatedItems = item.related_items || [];
    const relatedItemsHtml = relatedItems.slice(0, 3).map(rel => 
        `<span class="relationship-badge badge bg-secondary">${rel.relationship_type}: ${rel.name}</span>`
    ).join(' ');
    
    const moreRelatedText = relatedItems.length > 3 ? 
        `<span class="text-muted">+${relatedItems.length - 3} more</span>` : '';
    
    // Status badge
    const statusBadge = getStatusBadgeClass(item.sync_status || source);
    const statusText = getStatusDisplayName(item.sync_status || source);
    
    return `
        <tr data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}' 
            data-type="${itemType}" 
            data-level="${level}"
            data-node-id="${itemId}"
            ${parentId ? `data-parent-id="${parentId}"` : ''}
            ${level > 0 ? 'style="display: none;"' : ''}>
            <td>
                <input type="checkbox" class="item-checkbox" value="${item.urn}">
            </td>
            <td>
                <i class="${typeIcon}"></i>
                <span class="badge ${itemType === 'node' ? 'bg-warning' : 'bg-info'} ms-1">${typeBadge}</span>
            </td>
            <td class="name-cell">
                <div class="hierarchy-container">
                    ${treeConnectors}
                    ${expandButton}
                    <span class="item-name">${item.name || 'Unnamed'}</span>
                </div>
            </td>
            <td class="description-cell">
                <div class="description-preview">${truncatedDescription}</div>
            </td>
            <td class="related-items-cell">
                <div>${relatedItemsHtml}</div>
                <div>${moreRelatedText}</div>
            </td>
            <td>
                <span class="badge ${statusBadge} status-badge">${statusText}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="showItemDetail(this)" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                ${getActionButton(item, source, itemType)}
            </td>
        </tr>
    `;
}

function getActionButton(item, source, itemType) {
    if (source === 'remote') {
        return `
            <button class="btn btn-sm btn-outline-primary" onclick="importItem('${item.urn}', '${itemType}')" title="Import to Local">
                <i class="fas fa-download"></i>
            </button>
        `;
    } else if (source === 'synced' || (item.sync_status && item.sync_status !== 'REMOTE_ONLY')) {
        const itemId = item.id || 'view';
        const detailUrl = `/metadata/glossary/${itemType}/${itemId}/`;
        return `
            <a href="${detailUrl}" class="btn btn-sm btn-outline-success" title="Edit">
                <i class="fas fa-edit"></i>
            </a>
        `;
    }
    return '';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'LOCAL_ONLY':
        case 'local': return 'bg-secondary text-white';
        case 'REMOTE_ONLY':
        case 'remote': return 'bg-info text-white';
        case 'SYNCED':
        case 'synced': return 'bg-success text-white';
        case 'MODIFIED':
        case 'modified': return 'bg-warning text-dark';
        default: return 'bg-light text-dark';
    }
}

function getStatusDisplayName(status) {
    switch(status) {
        case 'LOCAL_ONLY':
        case 'local': return 'Local Only';
        case 'REMOTE_ONLY':
        case 'remote': return 'Remote Only';
        case 'SYNCED':
        case 'synced': return 'Synced';
        case 'MODIFIED':
        case 'modified': return 'Modified';
        default: return status;
    }
}

// Global function to show item details in modal
window.showItemDetail = function(button) {
    const row = button.closest('tr');
    const itemData = JSON.parse(row.getAttribute('data-item'));
    const itemType = row.getAttribute('data-type');
    
    // Populate modal
    document.getElementById('detailModalLabel').textContent = `${itemType === 'node' ? 'Node' : 'Term'}: ${itemData.name}`;
    
    let modalContent = `
        <dl class="row">
            <dt class="col-sm-3">Name:</dt>
            <dd class="col-sm-9">${itemData.name || 'N/A'}</dd>
            
            <dt class="col-sm-3">URN:</dt>
            <dd class="col-sm-9"><code>${itemData.urn}</code></dd>
            
            <dt class="col-sm-3">Type:</dt>
            <dd class="col-sm-9">${itemType === 'node' ? 'Glossary Node' : 'Glossary Term'}</dd>
            
            <dt class="col-sm-3">Status:</dt>
            <dd class="col-sm-9">
                <span class="badge ${getStatusBadgeClass(itemData.sync_status)}">${getStatusDisplayName(itemData.sync_status)}</span>
            </dd>
            
            <dt class="col-sm-3">Description:</dt>
            <dd class="col-sm-9">${itemData.description || 'No description available'}</dd>
    `;
    
    // Add parent information
    if (itemData.parent_urn || itemData.parent_node_urn) {
        modalContent += `
            <dt class="col-sm-3">Parent:</dt>
            <dd class="col-sm-9"><code>${itemData.parent_urn || itemData.parent_node_urn}</code></dd>
        `;
    }
    
    // Add owners
    if (itemData.owners && itemData.owners.length > 0) {
        modalContent += `
            <dt class="col-sm-3">Owners:</dt>
            <dd class="col-sm-9">
                ${itemData.owners.map(owner => `<span class="owner-item">${owner.name}</span>`).join('')}
            </dd>
        `;
    }
    
    // Add domain (for terms)
    if (itemData.domain) {
        modalContent += `
            <dt class="col-sm-3">Domain:</dt>
            <dd class="col-sm-9"><code>${itemData.domain.urn}</code></dd>
        `;
    }
    
    // Add term-specific fields
    if (itemType === 'term') {
        if (itemData.term_source) {
            modalContent += `
                <dt class="col-sm-3">Source:</dt>
                <dd class="col-sm-9">${itemData.term_source}</dd>
            `;
        }
        
        if (itemData.source_url) {
            modalContent += `
                <dt class="col-sm-3">Source URL:</dt>
                <dd class="col-sm-9"><a href="${itemData.source_url}" target="_blank">${itemData.source_url}</a></dd>
            `;
        }
        
        if (itemData.deprecated) {
            modalContent += `
                <dt class="col-sm-3">Status:</dt>
                <dd class="col-sm-9"><span class="badge bg-danger">Deprecated</span></dd>
            `;
        }
    }
    
    // Add related items
    if (itemData.related_items && itemData.related_items.length > 0) {
        modalContent += `
            <dt class="col-sm-3">Related Items:</dt>
            <dd class="col-sm-9">
        `;
        
        itemData.related_items.forEach(rel => {
            modalContent += `
                <div class="relationship-item">
                    <span class="badge bg-primary me-2">${rel.relationship_type}</span>
                    <span class="badge bg-secondary me-2">${rel.type}</span>
                    <span class="fw-medium">${rel.name}</span>
                    <small class="text-muted ms-auto">${rel.direction}</small>
                </div>
            `;
        });
        
        modalContent += `</dd>`;
    }
    
    // Add custom properties
    if (itemData.custom_properties && itemData.custom_properties.length > 0) {
        modalContent += `
            <dt class="col-sm-3">Custom Properties:</dt>
            <dd class="col-sm-9">
        `;
        
        itemData.custom_properties.forEach(prop => {
            modalContent += `
                <div><strong>${prop.key}:</strong> ${prop.value}</div>
            `;
        });
        
        modalContent += `</dd>`;
    }
    
    modalContent += `</dl>`;
    
    document.getElementById('detailModalBody').innerHTML = modalContent;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
};

// Global function to import items
window.importItem = function(urn, type) {
    // Implementation for importing items
    showSuccessNotification(`Importing ${type}...`);
};

function showSuccessNotification(message) {
    showNotification(message, 'success');
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show notification`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 