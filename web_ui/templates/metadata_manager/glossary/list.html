{% extends "base.html" %}
{% load static %}
{% load metadata_manager_filters %}

{% block title %}DataHub Glossary{% endblock %}

{% block extra_css %}
<style>
    .card-header-tabs {
        margin-right: -1.25rem;
        margin-bottom: -0.75rem;
        margin-left: -1.25rem;
        border-bottom: 0;
    }
    .glossary-card {
        margin-bottom: 1.5rem;
    }
    .glossary-item {
        transition: background-color 0.2s;
    }
    .glossary-item:hover {
        background-color: rgba(0,0,0,0.02);
    }
    .node-level-1 {
        padding-left: 1.5rem;
    }
    .node-level-2 {
        padding-left: 3rem;
    }
    .node-level-3 {
        padding-left: 4.5rem;
    }
    .badge-category {
        font-size: 0.8em;
        padding: 0.35em 0.65em;
    }
    .toggle-node-children {
        cursor: pointer;
        width: 18px;
        display: inline-block;
        text-align: center;
    }
    .toggle-node-children[aria-expanded="true"] .fa-caret-right {
        transform: rotate(90deg);
    }
    .glossary-node-children {
        border-left: 1px dashed #dee2e6;
        margin-left: 1.5rem;
    }
    .node-icon {
        width: 20px;
        display: inline-block;
        text-align: center;
    }
    .description-preview {
        max-height: 60px;
        overflow: hidden;
        color: #6c757d;
        font-size: 0.9em;
    }
    /* Responsive table */
    @media (max-width: 768px) {
        .responsive-table th:nth-child(3),
        .responsive-table td:nth-child(3) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>DataHub Glossary</h1>
        <div>
            <a href="{% url 'metadata_manager:glossary_node_create' %}" class="btn btn-primary">
                <i class="fas fa-folder-plus me-1"></i> Create Node
            </a>
            <a href="{% url 'metadata_manager:glossary_term_create' %}" class="btn btn-success ms-2">
                <i class="fas fa-tag me-1"></i> Create Term
            </a>
            <div class="dropdown d-inline-block ms-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="batchActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-tasks me-1"></i> Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="batchActionsDropdown">
                    <li><h6 class="dropdown-header">Selected Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-selected-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push to DataHub
                    </button></li>
                    <li><button type="button" class="dropdown-item" id="download-selected-items">
                        <i class="fas fa-download me-1"></i> Download Selected
                    </button></li>
                    {% if has_git_integration %}
                    <li><button type="button" class="dropdown-item" id="add-selected-to-git">
                        <i class="fab fa-github me-1"></i> Add to GitHub PR
                    </button></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">All Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-all-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push All
                    </button></li>
                    <li><a href="{% url 'metadata_manager:glossary_pull' %}" class="dropdown-item">
                        <i class="fas fa-cloud-download-alt me-1"></i> Pull from DataHub
                    </a></li>
                    <li><a href="{% url 'metadata_manager:glossary_import_export' %}" class="dropdown-item">
                        <i class="fas fa-file-export me-1"></i> Import/Export
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
            
    {% if not has_datahub_connection %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-1"></i> Not connected to DataHub. Please check your connection settings.
    </div>
    {% endif %}
            
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Simplified Glossary Tabs (2 tabs like the tests page) -->
    <ul class="nav nav-tabs mb-4" id="glossaryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="server-tab" data-bs-toggle="tab" data-bs-target="#server-glossary" 
                   type="button" role="tab" aria-controls="server-glossary" aria-selected="true">
                <i class="fas fa-server me-1"></i> Server Glossary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-glossary" 
                   type="button" role="tab" aria-controls="local-glossary" aria-selected="false">
                <i class="fas fa-laptop me-1"></i> Local Glossary
                <span class="badge bg-primary ms-1" id="local-glossary-count">{{ local_only_count|add:modified_count }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="glossaryTabsContent">
        <!-- Server Glossary Tab (Previously Synced + Remote Only) -->
        <div class="tab-pane fade show active" id="server-glossary" role="tabpanel" aria-labelledby="server-tab">
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">DataHub Server Glossary</h5>
                    <div class="d-flex">
                        <div class="input-group">
                            <input type="text" id="server-glossary-search" class="form-control form-control-sm me-2" 
                                   placeholder="Filter items..." value="">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="server-clear-filter">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="ms-2">
                            <a href="{% url 'metadata_manager:glossary_list' %}" class="btn btn-sm btn-outline-secondary" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="expand-all-glossary" title="Expand All">
                                <i class="fas fa-expand-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="collapse-all-glossary" title="Collapse All">
                                <i class="fas fa-compress-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Synced nodes (root level) -->
                    {% if synced_nodes %}
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Synced Glossary Items</h6>
                        {% for node in synced_nodes %}
                            {% render_node_hierarchy node "synced" 1 %}
                        {% endfor %}
                        
                        <!-- Synced terms (root level) -->
                        {% if synced_root_terms %}
                            {% for term in synced_root_terms %}
                            <div class="glossary-item py-2">
                                        <div class="d-flex align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input select-item" type="checkbox" value="{{ term.id }}" data-item-type="term" data-sync-status="synced">
                                    </div>
                                    <div class="ms-2 d-flex align-items-center flex-grow-1">
                                        <span class="me-2" style="width:18px;"></span>
                                            <span class="node-icon me-2">
                                            <i class="fas fa-tag text-info"></i>
                                            </span>
                                        <span>{{ term.name }}</span>
                                        <span class="badge bg-success text-white ms-2 badge-category">Synced</span>
                                    </div>
                                    <div class="ms-2">
                                        <span class="badge bg-info text-white">Term</span>
                                    </div>
                                    <div class="ms-3">
                                        <a href="{% url 'metadata_manager:glossary_term_detail' term.id %}" class="btn btn-sm btn-outline-secondary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                                            {% endif %}
                                        </div>
                    {% endif %}
                                
                    <!-- Remote only nodes (root level) -->
                    {% if remote_only_nodes %}
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Remote Glossary Items</h6>
                        {% for node in remote_only_nodes %}
                            {% render_node_hierarchy node "remote-only" 1 remote_only_terms %}
                                            {% endfor %}
                                            
                        <!-- Root level glossary terms (without parent nodes) -->
                        {% if remote_only_terms.root_terms %}
                            {% for term in remote_only_terms.root_terms %}
                            <div class="glossary-item py-2">
                                <div class="d-flex align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input select-item" type="checkbox" value="{{ term.urn }}" data-item-type="term" data-sync-status="remote-only">
                                    </div>
                                    <div class="ms-2 d-flex align-items-center flex-grow-1">
                                        <span class="me-2" style="width:18px;"></span>
                                        <span class="node-icon me-2">
                                            <i class="fas fa-tag text-info"></i>
                                        </span>
                                        <span>{{ term.name }}</span>
                                        <span class="badge bg-info text-white ms-2 badge-category">Remote</span>
                                    </div>
                                    <div class="ms-2">
                                        <span class="badge bg-info text-white">Term</span>
                                    </div>
                                    <div class="ms-3">
                                        <form action="{% url 'metadata_manager:glossary_pull' %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="term_urn" value="{{ term.urn }}">
                                            <input type="hidden" name="term_name" value="{{ term.name }}">
                                            <input type="hidden" name="term_description" value="{{ term.description|default:'' }}">
                                            <input type="hidden" name="term_source" value="{{ term.term_source|default:'' }}">
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Import to Local">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if not synced_nodes and not remote_only_nodes and not synced_root_terms and not remote_only_terms %}
                    <div class="text-center py-3">
                        <em>No glossary items found in DataHub.</em>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Local Glossary Tab (Previously Local Only + Modified) -->
        <div class="tab-pane fade" id="local-glossary" role="tabpanel" aria-labelledby="local-tab">
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Local Glossary</h5>
                    <div class="d-flex">
                        <div class="input-group">
                            <input type="text" id="local-glossary-search" class="form-control form-control-sm me-2" 
                                   placeholder="Filter items..." value="">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="local-clear-filter">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Local only nodes (root level) -->
                    {% if local_only_nodes %}
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Local Only Items</h6>
                        {% for node in local_only_nodes %}
                            {% render_node_hierarchy node "local-only" 1 %}
                        {% endfor %}
                        
                        <!-- Local only root terms (without parent nodes) -->
                        {% if local_only_root_terms %}
                            {% for term in local_only_root_terms %}
                            <div class="glossary-item py-2">
                                        <div class="d-flex align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input select-item" type="checkbox" value="{{ term.id }}" data-item-type="term" data-sync-status="local-only">
                                    </div>
                                    <div class="ms-2 d-flex align-items-center flex-grow-1">
                                        <span class="me-2" style="width:18px;"></span>
                                            <span class="node-icon me-2">
                                            <i class="fas fa-tag text-info"></i>
                                            </span>
                                        <span>{{ term.name }}</span>
                                        <span class="badge bg-secondary text-white ms-2 badge-category">Local</span>
                                    </div>
                                    <div class="ms-2">
                                        <span class="badge bg-info text-white">Term</span>
                                    </div>
                                    <div class="ms-3">
                                        <div class="btn-group">
                                            <a href="{% url 'metadata_manager:glossary_term_detail' term.id %}" class="btn btn-sm btn-outline-secondary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if has_datahub_connection and term.can_deploy %}
                                            <form action="{% url 'metadata_manager:glossary_term_deploy' term.id %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Deploy to DataHub">
                                                    <i class="fas fa-cloud-upload-alt"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Modified nodes (root level) -->
                    {% if modified_nodes %}
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Modified Items</h6>
                        {% for node in modified_nodes %}
                            {% render_node_hierarchy node "modified" 1 %}
                                            {% endfor %}
                                            
                        <!-- Modified root terms (without parent nodes) -->
                        {% if modified_root_terms %}
                            {% for term in modified_root_terms %}
                            <div class="glossary-item py-2">
                                <div class="d-flex align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input select-item" type="checkbox" value="{{ term.id }}" data-item-type="term" data-sync-status="modified">
                                    </div>
                                    <div class="ms-2 d-flex align-items-center flex-grow-1">
                                        <span class="me-2" style="width:18px;"></span>
                                        <span class="node-icon me-2">
                                            <i class="fas fa-tag text-info"></i>
                                        </span>
                                        <span>{{ term.name }}</span>
                                        <span class="badge bg-warning text-dark ms-2 badge-category">Modified</span>
                                    </div>
                                    <div class="ms-2">
                                        <span class="badge bg-info text-white">Term</span>
                                    </div>
                                    <div class="ms-3">
                                        <div class="btn-group">
                                            <a href="{% url 'metadata_manager:glossary_term_detail' term.id %}" class="btn btn-sm btn-outline-secondary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if has_datahub_connection and term.can_deploy %}
                                            <form action="{% url 'metadata_manager:glossary_term_deploy' term.id %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Deploy to DataHub">
                                                    <i class="fas fa-cloud-upload-alt"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if not local_only_nodes and not modified_nodes and not local_only_root_terms and not modified_root_terms %}
                    <div class="text-center py-3">
                        <em>No local glossary items found.</em>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Existing modals and JavaScript -->
<!-- ... existing code ... -->

<!-- GitHub PR Modal -->
<div class="modal fade" id="githubPrModal" tabindex="-1" aria-labelledby="githubPrModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="github-pr-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="githubPrModalLabel">Add to GitHub PR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="github-environment" class="form-label">Target Environment</label>
                        <select class="form-control" id="github-environment" name="environment" required>
                            {% for env in environments %}
                                <option value="{{ env.name }}">{{ env.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add to PR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Node Modal -->
<div class="modal fade" id="deleteNodeModal" tabindex="-1" aria-labelledby="deleteNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteNodeModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the node <strong id="delete-node-name"></strong>?</p>
                <p class="text-danger">This will also delete all child nodes and terms associated with this node.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-node-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Term Modal -->
<div class="modal fade" id="deleteTermModal" tabindex="-1" aria-labelledby="deleteTermModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTermModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the term <strong id="delete-term-name"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-term-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Debug info for terms
console.log("Remote terms debug info available in the debug-info section");
console.log("Nodes available:", {% if nodes %}true{% else %}false{% endif %});
console.log("Nodes count:", {% if nodes %}{{ nodes|length }}{% else %}0{% endif %});

$(document).ready(function() {
        // Toggle node children with animation
        $(document).on('click', '.toggle-node-children', function() {
            $(this).find('i').toggleClass('fa-rotate-90');
        });
        
        // Debug the create node and term buttons
        $('[data-bs-target="#createNodeModal"]').on('click', function() {
            console.log("Create Node button clicked");
        });
        
        $('[data-bs-target="#createTermModal"]').on('click', function() {
            console.log("Create Term button clicked");
        });
        
        // Debug form submissions
        $('#createNodeModal form').on('submit', function() {
            console.log("Create Node form submitted");
        });
        
        $('#createTermModal form').on('submit', function() {
            console.log("Create Term form submitted");
        });
        
        // Expand all nodes
        $('#expand-all-glossary, #expand-all-local, #expand-all-remote, #expand-all-modified').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId} .collapse`).collapse('show');
            $(`#${tabId} .toggle-node-children i`).addClass('fa-rotate-90');
        });
        
        // Collapse all nodes
        $('#collapse-all-glossary, #collapse-all-local, #collapse-all-remote, #collapse-all-modified').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId} .collapse`).collapse('hide');
            $(`#${tabId} .toggle-node-children i`).removeClass('fa-rotate-90');
    });
    
    // Select all checkboxes
        $('#select-all-synced, #select-all-local, #select-all-remote, #select-all-modified').change(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            const isChecked = $(this).prop('checked');
            $(`#${tabId} .node-checkbox, #${tabId} .term-checkbox`).prop('checked', isChecked);
        });
        
        // Filter items in each tab
        $('#synced-search, #local-search, #remote-search, #modified-search').on('keyup', function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            const searchTerm = $(this).val().toLowerCase();
            
            if (searchTerm.length > 0) {
                $(`#${tabId} .glossary-item`).each(function() {
                    const text = $(this).text().toLowerCase();
                    const match = text.indexOf(searchTerm) > -1;
                    $(this).toggle(match);
                });
            } else {
                $(`#${tabId} .glossary-item`).show();
            }
        });
        
        // Clear filters
        $('#synced-clear-filter, #local-clear-filter, #remote-clear-filter, #modified-clear-filter').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId}-search`).val('');
            $(`#${tabId} .glossary-item`).show();
        });
        
        // Handle batch actions
        $('#push-selected-items').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to push to DataHub.');
            return;
        }
        
            // Submit form with selected items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="push_selected">');
            
            selectedNodes.forEach(function(nodeId) {
                form.append(`<input type="hidden" name="selected_nodes" value="${nodeId}">`);
            });
            
            selectedTerms.forEach(function(termId) {
                form.append(`<input type="hidden" name="selected_terms" value="${termId}">`);
            });
            
            $('body').append(form);
        form.submit();
        });
        
        // Add to GitHub PR action
        $('#add-selected-to-git').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to add to GitHub PR.');
            return;
        }
        
            // Open GitHub PR modal
            $('#githubPrModal').modal('show');
            
            // Store selected items in the modal form
            $('#github-pr-form').data('selected-nodes', selectedNodes);
            $('#github-pr-form').data('selected-terms', selectedTerms);
        });
        
        // GitHub PR form submission
        $('#github-pr-form').submit(function(e) {
            e.preventDefault();
            
            const selectedNodes = $(this).data('selected-nodes') || [];
            const selectedTerms = $(this).data('selected-terms') || [];
            const environment = $('#github-environment').val();
            
            // Submit form with selected items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="add_to_git">');
            form.append(`<input type="hidden" name="environment" value="${environment}">`);
            
            selectedNodes.forEach(function(nodeId) {
                form.append(`<input type="hidden" name="selected_nodes" value="${nodeId}">`);
            });
            
            selectedTerms.forEach(function(termId) {
                form.append(`<input type="hidden" name="selected_terms" value="${termId}">`);
            });
            
            $('body').append(form);
        form.submit();
        });
        
        // Push all items
        $('#push-all-items').click(function() {
            if (!confirm('Are you sure you want to push all local and modified items to DataHub?')) {
            return;
        }
        
            // Submit form to push all items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="push_all">');
            $('body').append(form);
        form.submit();
        });
        
        // Download selected items
        $('#download-selected-items').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to download.');
            return;
        }
        
            // TODO: Implement download functionality
            alert('Download functionality not yet implemented.');
        });
        
        // Download all items
        $('#download-all-items').click(function() {
            // TODO: Implement download functionality
            alert('Download functionality not yet implemented.');
    });
    
    // Handle delete node modal
    $(document).on('click', '.delete-node', function() {
        const nodeId = $(this).data('node-id');
        const nodeName = $(this).data('node-name');
        
        // Update modal content
        $('#delete-node-name').text(nodeName);
        
        // Update form action
        $('#delete-node-form').attr('action', `{% url 'metadata_manager:glossary_node_detail' 999999 %}`.replace('999999', nodeId));
    });
    
    // Handle delete term modal
    $(document).on('click', '.delete-term', function() {
        const termId = $(this).data('term-id');
        const termName = $(this).data('term-name');
        
        // Update modal content
        $('#delete-term-name').text(termName);
        
        // Update form action
        $('#delete-term-form').attr('action', `{% url 'metadata_manager:glossary_term_detail' 999999 %}`.replace('999999', termId));
    });
});
</script>

<!-- Create Node Modal -->
<div class="modal fade" id="createNodeModal" tabindex="-1" aria-labelledby="createNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'metadata_manager:glossary_node_create' %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="createNodeModalLabel">Create Glossary Node</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="node-name" class="form-label">Node Name</label>
                        <input type="text" class="form-control" id="node-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="node-description" class="form-label">Description</label>
                        <textarea class="form-control" id="node-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="node-parent" class="form-label">Parent Node (Optional)</label>
                        <select class="form-control" id="node-parent" name="parent_id">
                            <option value="">-- No Parent --</option>
                            {% for node in nodes %}
                                <option value="{{ node.id }}">{{ node.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Node</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Term Modal -->
<div class="modal fade" id="createTermModal" tabindex="-1" aria-labelledby="createTermModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'metadata_manager:glossary_term_create' %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="createTermModalLabel">Create Glossary Term</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="term-name" class="form-label">Term Name</label>
                        <input type="text" class="form-control" id="term-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="term-description" class="form-label">Description</label>
                        <textarea class="form-control" id="term-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="term-source" class="form-label">Term Source (Optional)</label>
                        <input type="text" class="form-control" id="term-source" name="term_source">
                    </div>
                    <div class="mb-3">
                        <label for="term-parent-node" class="form-label">Parent Node (Optional)</label>
                        <select class="form-control" id="term-parent-node" name="parent_node_id">
                            <option value="">-- No Parent --</option>
                            {% for node in nodes %}
                                <option value="{{ node.id }}">{{ node.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Term</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %} 