{% extends "base.html" %}
{% load static %}

{% block title %}DataHub Glossary{% endblock %}

{% block extra_css %}
<style>
    .card-header-tabs {
        margin-right: -1.25rem;
        margin-bottom: -0.75rem;
        margin-left: -1.25rem;
        border-bottom: 0;
    }
    .glossary-card {
        margin-bottom: 1.5rem;
    }
    .glossary-item {
        transition: background-color 0.2s;
    }
    .glossary-item:hover {
        background-color: rgba(0,0,0,0.02);
    }
    .node-level-1 {
        padding-left: 1.5rem;
    }
    .node-level-2 {
        padding-left: 3rem;
    }
    .node-level-3 {
        padding-left: 4.5rem;
    }
    .badge-category {
        font-size: 0.8em;
        padding: 0.35em 0.65em;
    }
    .toggle-node-children {
        cursor: pointer;
        width: 18px;
        display: inline-block;
        text-align: center;
    }
    .toggle-node-children[aria-expanded="true"] .fa-caret-right {
        transform: rotate(90deg);
    }
    .glossary-node-children {
        border-left: 1px dashed #dee2e6;
        margin-left: 1.5rem;
    }
    .node-icon {
        width: 20px;
        display: inline-block;
        text-align: center;
    }
    .description-preview {
        max-height: 60px;
        overflow: hidden;
        color: #6c757d;
        font-size: 0.9em;
    }
    /* Responsive table */
    @media (max-width: 768px) {
        .responsive-table th:nth-child(3),
        .responsive-table td:nth-child(3) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>DataHub Glossary</h1>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNodeModal">
                <i class="fas fa-folder-plus me-1"></i> Create Node
            </button>
            <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#createTermModal">
                <i class="fas fa-tag me-1"></i> Create Term
            </button>
            <div class="dropdown d-inline-block ms-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="batchActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-tasks me-1"></i> Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="batchActionsDropdown">
                    <li><h6 class="dropdown-header">Selected Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-selected-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push to DataHub
                    </button></li>
                    <li><button type="button" class="dropdown-item" id="download-selected-items">
                        <i class="fas fa-download me-1"></i> Download Selected
                    </button></li>
                    {% if has_git_integration %}
                    <li><button type="button" class="dropdown-item" id="add-selected-to-git">
                        <i class="fab fa-github me-1"></i> Add to GitHub PR
                    </button></li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">All Items</h6></li>
                    <li><button type="button" class="dropdown-item" id="push-all-items" {% if not has_datahub_connection %}disabled{% endif %}>
                        <i class="fas fa-cloud-upload-alt me-1"></i> Push All
                    </button></li>
                    <li><a href="{% url 'metadata_manager:glossary_pull' %}" class="dropdown-item">
                        <i class="fas fa-cloud-download-alt me-1"></i> Pull from DataHub
                    </a></li>
                    <li><a href="{% url 'metadata_manager:glossary_import_export' %}" class="dropdown-item">
                        <i class="fas fa-file-export me-1"></i> Import/Export
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
            
    {% if not has_datahub_connection %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-1"></i> Not connected to DataHub. Please check your connection settings.
    </div>
    {% endif %}
            
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Simplified Glossary Tabs (2 tabs like the tests page) -->
    <ul class="nav nav-tabs mb-4" id="glossaryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="server-tab" data-bs-toggle="tab" data-bs-target="#server-glossary" 
                   type="button" role="tab" aria-controls="server-glossary" aria-selected="true">
                <i class="fas fa-server me-1"></i> Server Glossary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-glossary" 
                   type="button" role="tab" aria-controls="local-glossary" aria-selected="false">
                <i class="fas fa-laptop me-1"></i> Local Glossary
                <span class="badge bg-primary ms-1" id="local-glossary-count">{{ local_only_count|add:modified_count }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="glossaryTabsContent">
        <!-- Server Glossary Tab (Previously Synced + Remote Only) -->
        <div class="tab-pane fade show active" id="server-glossary" role="tabpanel" aria-labelledby="server-tab">
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">DataHub Server Glossary</h5>
                    <div class="d-flex">
                        <div class="input-group">
                            <input type="text" id="server-glossary-search" class="form-control form-control-sm me-2" 
                                   placeholder="Filter items..." value="">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="server-clear-filter">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="ms-2">
                            <a href="{% url 'metadata_manager:glossary_list' %}" class="btn btn-sm btn-outline-secondary" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="expand-all-glossary" title="Expand All">
                                <i class="fas fa-expand-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="collapse-all-glossary" title="Collapse All">
                                <i class="fas fa-compress-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 responsive-table">
                            <thead>
                                <tr>
                                    <th width="2%">
                                        <input class="form-check-input" type="checkbox" id="select-all-server">
                                    </th>
                                    <th width="35%">Name</th>
                                    <th width="40%">Description</th>
                                    <th width="8%">Type</th>
                                    <th width="15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Root level nodes section -->
                                <tr class="glossary-tree-header">
                                    <td colspan="5" class="bg-light">
                                        <div class="d-flex align-items-center">
                                            <span class="toggle-node-children me-2" data-bs-toggle="collapse" data-bs-target="#server-root-nodes" role="button" aria-expanded="true" aria-controls="server-root-nodes">
                                                <i class="fas fa-caret-right"></i>
                                            </span>
                                            <span class="node-icon me-2">
                                                <i class="fas fa-folder text-warning"></i>
                                            </span>
                                            <span><strong>Root Level Nodes</strong></span>
                                            {% with root_nodes_count=synced_nodes|length|add:remote_only_nodes|length %}
                                            {% if root_nodes_count > 0 %}
                                            <span class="badge bg-warning ms-2">{{ root_nodes_count }}</span>
                                            {% endif %}
                                            {% endwith %}
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Include both synced and remote-only nodes in the server tab -->
                                <tr class="collapse show" id="server-root-nodes">
                                    <td colspan="5" class="p-0">
                                        <table class="table table-hover mb-0 w-100">
                                            {% for node in synced_nodes %}
                                            <!-- Existing synced nodes code -->
                                            {% endfor %}
                                            
                                            {% for node in remote_only_nodes %}
                                            <!-- Include remote-only nodes here -->
                                            {% endfor %}
                                        </table>
                                    </td>
                                </tr>
                                
                                <!-- Root level terms section -->
                                <!-- ... existing code ... -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Local Glossary Tab (Previously Local Only + Modified) -->
        <div class="tab-pane fade" id="local-glossary" role="tabpanel" aria-labelledby="local-tab">
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Local Glossary</h5>
                    <div class="d-flex">
                        <div class="input-group">
                            <input type="text" id="local-glossary-search" class="form-control form-control-sm me-2" 
                                   placeholder="Filter items..." value="">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="local-clear-filter">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0" id="local-glossary-table">
                            <thead>
                                <tr>
                                    <th width="2%">
                                        <input class="form-check-input" type="checkbox" id="select-all-local">
                                    </th>
                                    <th width="35%">Name</th>
                                    <th width="40%">Description</th>
                                    <th width="8%">Type</th>
                                    <th width="15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Include both local-only and modified items -->
                                <!-- Root level nodes section -->
                                <tr class="glossary-tree-header">
                                    <td colspan="5" class="bg-light">
                                        <div class="d-flex align-items-center">
                                            <span class="toggle-node-children me-2" data-bs-toggle="collapse" data-bs-target="#local-root-nodes" role="button" aria-expanded="true" aria-controls="local-root-nodes">
                                                <i class="fas fa-caret-right"></i>
                                            </span>
                                            <span class="node-icon me-2">
                                                <i class="fas fa-folder text-warning"></i>
                                            </span>
                                            <span><strong>Local Root Level Nodes</strong></span>
                                            {% with local_root_nodes_count=local_only_nodes|length|add:modified_nodes|length %}
                                            {% if local_root_nodes_count > 0 %}
                                            <span class="badge bg-warning ms-2">{{ local_root_nodes_count }}</span>
                                            {% endif %}
                                            {% endwith %}
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr class="collapse show" id="local-root-nodes">
                                    <td colspan="5" class="p-0">
                                        <table class="table table-hover mb-0 w-100">
                                            {% for node in local_only_nodes %}
                                            <!-- Local-only nodes code -->
                                            {% endfor %}
                                            
                                            {% for node in modified_nodes %}
                                            <!-- Modified nodes code -->
                                            {% endfor %}
                                        </table>
                                    </td>
                                </tr>
                                
                                <!-- Root level terms section -->
                                <!-- ... existing code for local terms ... -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Existing modals and JavaScript -->
<!-- ... existing code ... -->
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
        // Toggle node children with animation
        $(document).on('click', '.toggle-node-children', function() {
            $(this).find('i').toggleClass('fa-rotate-90');
        });
        
        // Expand all nodes
        $('#expand-all-glossary, #expand-all-local, #expand-all-remote, #expand-all-modified').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId} .collapse`).collapse('show');
            $(`#${tabId} .toggle-node-children i`).addClass('fa-rotate-90');
        });
        
        // Collapse all nodes
        $('#collapse-all-glossary, #collapse-all-local, #collapse-all-remote, #collapse-all-modified').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId} .collapse`).collapse('hide');
            $(`#${tabId} .toggle-node-children i`).removeClass('fa-rotate-90');
    });
    
    // Select all checkboxes
        $('#select-all-synced, #select-all-local, #select-all-remote, #select-all-modified').change(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            const isChecked = $(this).prop('checked');
            $(`#${tabId} .node-checkbox, #${tabId} .term-checkbox`).prop('checked', isChecked);
        });
        
        // Filter items in each tab
        $('#synced-search, #local-search, #remote-search, #modified-search').on('keyup', function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            const searchTerm = $(this).val().toLowerCase();
            
            if (searchTerm.length > 0) {
                $(`#${tabId} .glossary-item`).each(function() {
                    const text = $(this).text().toLowerCase();
                    const match = text.indexOf(searchTerm) > -1;
                    $(this).toggle(match);
                });
            } else {
                $(`#${tabId} .glossary-item`).show();
            }
        });
        
        // Clear filters
        $('#synced-clear-filter, #local-clear-filter, #remote-clear-filter, #modified-clear-filter').click(function() {
            const tabId = $(this).closest('.tab-pane').attr('id');
            $(`#${tabId}-search`).val('');
            $(`#${tabId} .glossary-item`).show();
        });
        
        // Handle batch actions
        $('#push-selected-items').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to push to DataHub.');
            return;
        }
        
            // Submit form with selected items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="push_selected">');
            
            selectedNodes.forEach(function(nodeId) {
                form.append(`<input type="hidden" name="selected_nodes" value="${nodeId}">`);
            });
            
            selectedTerms.forEach(function(termId) {
                form.append(`<input type="hidden" name="selected_terms" value="${termId}">`);
            });
            
            $('body').append(form);
        form.submit();
        });
        
        // Add to GitHub PR action
        $('#add-selected-to-git').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to add to GitHub PR.');
            return;
        }
        
            // Open GitHub PR modal
            $('#githubPrModal').modal('show');
            
            // Store selected items in the modal form
            $('#github-pr-form').data('selected-nodes', selectedNodes);
            $('#github-pr-form').data('selected-terms', selectedTerms);
        });
        
        // GitHub PR form submission
        $('#github-pr-form').submit(function(e) {
            e.preventDefault();
            
            const selectedNodes = $(this).data('selected-nodes') || [];
            const selectedTerms = $(this).data('selected-terms') || [];
            const environment = $('#github-environment').val();
            
            // Submit form with selected items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="add_to_git">');
            form.append(`<input type="hidden" name="environment" value="${environment}">`);
            
            selectedNodes.forEach(function(nodeId) {
                form.append(`<input type="hidden" name="selected_nodes" value="${nodeId}">`);
            });
            
            selectedTerms.forEach(function(termId) {
                form.append(`<input type="hidden" name="selected_terms" value="${termId}">`);
            });
            
            $('body').append(form);
        form.submit();
        });
        
        // Push all items
        $('#push-all-items').click(function() {
            if (!confirm('Are you sure you want to push all local and modified items to DataHub?')) {
            return;
        }
        
            // Submit form to push all items
            const form = $('<form action="{% url "metadata_manager:glossary_list" %}" method="post"></form>');
            form.append('{% csrf_token %}');
            form.append('<input type="hidden" name="action" value="push_all">');
            $('body').append(form);
        form.submit();
        });
        
        // Download selected items
        $('#download-selected-items').click(function() {
            const selectedNodes = $('.node-checkbox:checked').map(function() {
                return $(this).data('node-id');
            }).get();
            
            const selectedTerms = $('.term-checkbox:checked').map(function() {
                return $(this).data('term-id');
            }).get();
        
        if (selectedNodes.length === 0 && selectedTerms.length === 0) {
                alert('Please select at least one item to download.');
            return;
        }
        
            // TODO: Implement download functionality
            alert('Download functionality not yet implemented.');
        });
        
        // Download all items
        $('#download-all-items').click(function() {
            // TODO: Implement download functionality
            alert('Download functionality not yet implemented.');
    });
});
</script>
{% endblock %} 