{% extends "base.html" %}
{% load static %}
{% load metadata_manager_filters %}

{% block title %}DataHub Glossary{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    .description-cell {
        max-width: 300px;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .description-preview {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: 4.2em; /* 3 lines * 1.4 line-height */
    }
    
    .related-items-cell {
        max-width: 250px;
    }
    
    .relationship-badge {
        font-size: 0.7rem;
        margin: 0.1rem;
        padding: 0.2rem 0.4rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    .type-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tab-loading {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    
    .table-responsive {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
    
    /* Modal enhancements */
    .modal-body dl {
        margin-bottom: 0;
    }
    
    .modal-body dt {
        font-weight: 600;
        color: #495057;
        margin-top: 1rem;
    }
    
    .modal-body dt:first-child {
        margin-top: 0;
    }
    
    .modal-body dd {
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
    
    .relationship-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        padding: 0.25rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    
    .owner-item {
        display: inline-block;
        margin: 0.1rem;
        padding: 0.2rem 0.5rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    
    /* Interactive hierarchy styles */
    .hierarchy-container {
        display: flex;
        align-items: center;
        position: relative;
        min-height: 20px;
    }
    
    .tree-connector {
        position: relative;
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        margin-right: 2px;
    }
    
    .tree-connector::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        width: 1px;
        height: 100%;
        background-color: #dee2e6;
    }
    
    .tree-connector::after {
        content: '';
        position: absolute;
        left: 10px;
        top: 10px;
        width: 10px;
        height: 1px;
        background-color: #dee2e6;
    }
    
    /* Hide vertical line for last items in a group */
    .tree-connector.last-child::before {
        height: 10px;
    }
    
    /* Hide connectors for root level */
    tr[data-level="0"] .tree-connector {
        display: none;
    }
    
    .expand-button-container {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 4px;
    }
    
    /* Expand/collapse button styling */
    .expand-button {
        border: none !important;
        background: none !important;
        padding: 2px !important;
        margin: 0 !important;
        color: #6c757d;
        cursor: pointer;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
    }
    
    .expand-button:hover {
        color: #007bff !important;
        background-color: #f8f9fa !important;
    }
    
    .expand-icon {
        font-size: 12px;
        transition: transform 0.2s ease;
    }
    
    .expand-button:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    /* Item name styling */
    .item-name {
        font-weight: 500;
        margin-left: 2px;
        flex-grow: 1;
    }
    
    /* Smooth transitions for expand/collapse */
    tbody tr {
        transition: opacity 0.15s ease;
    }
    
    /* Better visual spacing */
    .table td {
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
    }
    
    /* Ensure consistent alignment */
    .name-cell {
        position: relative;
    }

    .table th {
        background-color: #f8f9fa;
        border-top: none;
    }

    /* Simple hierarchy visual styles */
    tr[data-level="0"] {
        background-color: #ffffff;
    }

    tr[data-level="1"] {
        background-color: #f8f9fa;
    }

    tr[data-level="2"] {
        background-color: #f1f3f4;
    }

    tr[data-level="1"]:hover,
    tr[data-level="2"]:hover {
        background-color: #e3f2fd !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hidden CSRF token for JavaScript -->
    <form style="display: none;">
        {% csrf_token %}
    </form>
    
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>DataHub Glossary</h1>
                <div class="d-flex gap-2">
                    <a href="{% url 'metadata_manager:glossary_node_create' %}" class="btn btn-primary">
                        <i class="fas fa-folder-plus me-1"></i> Create Node
                    </a>
                    <a href="{% url 'metadata_manager:glossary_term_create' %}" class="btn btn-success">
                        <i class="fas fa-tag me-1"></i> Create Term
                    </a>
                    <a href="{% url 'metadata_manager:glossary_import_export' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-file-export me-1"></i> Import/Export
                    </a>
                    <button type="button" class="btn btn-outline-info" id="refreshGlossary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
            
            {% if not has_datahub_connection %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Not connected to DataHub. Please check your connection settings.
                    <a href="{% url 'settings' %}" class="btn btn-sm btn-warning ms-2">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </div>
            {% endif %}
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Loading indicator -->
            <div id="loading-indicator" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading glossary data...</p>
            </div>

            <!-- Glossary content -->
            <div id="glossary-content" style="display: none;">
                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="h4 mb-0" id="total-items">0</div>
                                <small class="text-muted">Total Items</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="h4 mb-0" id="synced-count">0</div>
                                <small class="text-muted">Synced</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="h4 mb-0" id="owned-items">0</div>
                                <small class="text-muted">Owned</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="h4 mb-0" id="items-with-relationships">0</div>
                                <small class="text-muted">With Relationships</small>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Glossary Tabs -->
                <ul class="nav nav-tabs mb-4" id="glossaryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="synced-tab" data-bs-toggle="tab" data-bs-target="#synced-items" 
                               type="button" role="tab" aria-controls="synced-items" aria-selected="true">
                            <i class="fas fa-sync-alt me-1"></i> Synced Items
                            <span class="badge bg-success ms-1" id="synced-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-items" 
                               type="button" role="tab" aria-controls="local-items" aria-selected="false">
                            <i class="fas fa-laptop me-1"></i> Local Only Items
                            <span class="badge bg-secondary ms-1" id="local-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote-items" 
                               type="button" role="tab" aria-controls="remote-items" aria-selected="false">
                            <i class="fas fa-server me-1"></i> Remote Only Items
                            <span class="badge bg-info ms-1" id="remote-badge">0</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="glossaryTabsContent">
                    <!-- Synced Items Tab -->
                    <div class="tab-pane fade show active" id="synced-items" role="tabpanel" aria-labelledby="synced-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Synced Items</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="expandAllNodes()" title="Expand All">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="collapseAllNodes()" title="Collapse All">
                                            <i class="fas fa-compress-arrows-alt"></i>
                                        </button>
                                    </div>
                                    <div class="input-group" style="width: 300px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="synced-search" class="form-control" placeholder="Search synced items...">
                                        <button type="button" class="btn btn-outline-secondary" id="synced-clear">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0" id="synced-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Local Items Tab -->
                    <div class="tab-pane fade" id="local-items" role="tabpanel" aria-labelledby="local-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Local Only Items</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="expandAllNodes()" title="Expand All">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="collapseAllNodes()" title="Collapse All">
                                            <i class="fas fa-compress-arrows-alt"></i>
                                        </button>
                                    </div>
                                    <div class="input-group" style="width: 300px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="local-search" class="form-control" placeholder="Search local items...">
                                        <button type="button" class="btn btn-outline-secondary" id="local-clear">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0" id="local-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Remote Items Tab -->
                    <div class="tab-pane fade" id="remote-items" role="tabpanel" aria-labelledby="remote-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Remote Only Items</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="expandAllNodes()" title="Expand All">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="collapseAllNodes()" title="Collapse All">
                                            <i class="fas fa-compress-arrows-alt"></i>
                                        </button>
                                    </div>
                                    <div class="input-group" style="width: 300px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="remote-search" class="form-control" placeholder="Search remote items...">
                                        <button type="button" class="btn btn-outline-secondary" id="remote-clear">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0" id="remote-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Glossary Item View Modal -->
<div class="modal fade" id="itemViewModal" tabindex="-1" aria-labelledby="itemViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemViewModalLabel">Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Basic Information -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-4">Name:</dt>
                                    <dd class="col-sm-8" id="modal-item-name">-</dd>
                                    
                                    <dt class="col-sm-4">Type:</dt>
                                    <dd class="col-sm-8" id="modal-item-type">-</dd>
                                    
                                    <dt class="col-sm-4">Description:</dt>
                                    <dd class="col-sm-8" id="modal-item-description">-</dd>
                                    
                                    <dt class="col-sm-4">Status:</dt>
                                    <dd class="col-sm-8">
                                        <span id="modal-item-status" class="badge">-</span>
                                    </dd>
                                    
                                    <dt class="col-sm-4">URN:</dt>
                                    <dd class="col-sm-8">
                                        <code id="modal-item-urn" class="small">-</code>
                                    </dd>
                                    
                                    <dt class="col-sm-4" id="modal-parent-label" style="display: none;">Parent:</dt>
                                    <dd class="col-sm-8" id="modal-parent-value" style="display: none;">
                                        <code id="modal-item-parent" class="small">-</code>
                                    </dd>
                                </dl>
                                
                                <div class="mt-3">
                                    <a href="#" id="modal-datahub-link" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-external-link-alt me-1"></i> View in DataHub
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ownership Information -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-users me-2"></i>Ownership</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-owners-list">
                                    <p class="text-muted">No ownership information available</p>
                                </div>
                                
                                <div id="modal-last-modified" class="mt-3">
                                    <!-- Last modified info will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Relationships -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-project-diagram me-2"></i>Relationships</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-relationships-list">
                                    <p class="text-muted">No relationships available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Glossary Properties -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Glossary Properties</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-glossary-properties">
                                    <p class="text-muted">No additional properties available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Raw JSON Data -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-code me-2"></i>Raw Data</h6>
                            </div>
                            <div class="card-body">
                                <pre id="modal-raw-json" class="language-json"><code>Loading...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables
let glossaryData = {
    synced_items: [],
    local_only_items: [],
    remote_only_items: [],
    datahub_url: ''
};
let currentSearch = {
    synced: '',
    local: '',
    remote: ''
};

document.addEventListener('DOMContentLoaded', function() {
    loadGlossaryData();
    
    // Search functionality for each tab
    ['synced', 'local', 'remote'].forEach(tab => {
        const searchInput = document.getElementById(`${tab}-search`);
        const clearButton = document.getElementById(`${tab}-clear`);
        
        searchInput.addEventListener('input', function() {
            currentSearch[tab] = this.value.toLowerCase();
            displayTabContent(tab);
        });
        
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            currentSearch[tab] = '';
            displayTabContent(tab);
        });
    });
    
    // Refresh button
    document.getElementById('refreshGlossary').addEventListener('click', function() {
        loadGlossaryData();
    });
});

function loadGlossaryData() {
    console.log('Loading glossary data...');
    showLoading(true);
    
    fetch('/metadata/glossary/data/')
        .then(response => {
            console.log('Received response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Parsed data:', data.success, 'Items:', data.data?.local_only_items?.length || 0);
            if (data.success) {
                glossaryData = data.data;
                updateStatistics(data.data.statistics);
                updateTabBadges();
                displayAllTabs();
            } else {
                console.error('Data loading failed:', data.error);
                showError('Failed to load glossary: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading glossary:', error);
            showError('Failed to load glossary data: ' + error.message);
        })
        .finally(() => {
            showLoading(false);
        });
}

function showLoading(show) {
    document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
    document.getElementById('glossary-content').style.display = show ? 'none' : 'block';
}

function updateStatistics(stats) {
    document.getElementById('total-items').textContent = stats.total_items || 0;
    document.getElementById('synced-count').textContent = stats.synced_count || 0;
    document.getElementById('owned-items').textContent = stats.owned_items || 0;
    document.getElementById('items-with-relationships').textContent = stats.items_with_relationships || 0;
}

function updateTabBadges() {
    document.getElementById('synced-badge').textContent = glossaryData.synced_items.length;
    document.getElementById('local-badge').textContent = glossaryData.local_only_items.length;
    document.getElementById('remote-badge').textContent = glossaryData.remote_only_items.length;
}

function displayAllTabs() {
    displayTabContent('synced');
    displayTabContent('local');
    displayTabContent('remote');
}

function displayTabContent(tabType) {
    console.log('Displaying tab content for:', tabType);
    
    let items, contentId;
    
    try {
        switch(tabType) {
            case 'synced':
                items = glossaryData.synced_items.map(item => item.combined);
                contentId = 'synced-content';
                break;
            case 'local':
                items = glossaryData.local_only_items;
                contentId = 'local-content';
                break;
            case 'remote':
                items = glossaryData.remote_only_items;
                contentId = 'remote-content';
                break;
        }
        
        console.log(`Tab ${tabType}: ${items?.length || 0} items`);
        
        // Debug: Log first item to understand data structure
        if (items && items.length > 0) {
            console.log('Sample item data structure:', {
                name: items[0].name,
                entity_type: items[0].entity_type,
                __typename: items[0].__typename,
                type: items[0].type,
                urn: items[0].urn,
                keys: Object.keys(items[0])
            });
        }
        
        // Sort items alphabetically by name (A-Z)
        if (items && items.length > 0) {
            items.sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
        }
        
        // Filter items based on search
        const searchTerm = currentSearch[tabType];
        if (searchTerm) {
            items = items.filter(item => {
                const entityType = determineEntityType(item);
                return (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.description || '').toLowerCase().includes(searchTerm) ||
                    (entityType || '').toLowerCase().includes(searchTerm) ||
                    (item.urn || '').toLowerCase().includes(searchTerm) ||
                    (item.parent_name || '').toLowerCase().includes(searchTerm);
            });
        }
        
        const content = document.getElementById(contentId);
        if (!content) {
            console.error('Content element not found:', contentId);
            return;
        }
        
        if (items.length === 0) {
            console.log(`No items for ${tabType}, showing empty state`);
            content.innerHTML = getEmptyStateHTML(tabType, searchTerm);
            return;
        }
        
        console.log(`Generating table for ${tabType} with ${items.length} items`);
        const tableHTML = generateTableHTML(items, tabType);
        content.innerHTML = tableHTML;
        
        // Attach click handlers for view buttons
        content.querySelectorAll('.view-item').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const itemData = JSON.parse(row.dataset.item);
                showItemDetails(itemData);
            });
        });
        
        // Attach click handlers for expand/collapse buttons
        content.querySelectorAll('.expand-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const icon = this.querySelector('.expand-icon');
                const nodeUrn = icon.id.replace('icon-', '');
                toggleNodeChildren(nodeUrn);
            });
        });
        
        console.log(`Successfully rendered ${tabType} tab`);
        
    } catch (error) {
        console.error(`Error displaying ${tabType} tab:`, error);
        const content = document.getElementById(contentId);
        if (content) {
            content.innerHTML = `<div class="alert alert-danger">Error loading ${tabType} glossary items: ${error.message}</div>`;
        }
    }
}

function generateTableHTML(items, tabType) {
    // Organize items into a hierarchy
    const hierarchy = organizeHierarchy(items);
    
    return `
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>URN</th>
                        <th>Status</th>
                        <th>Owners</th>
                        <th>Relationships</th>
                        <th width="15%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${renderHierarchicalItems(hierarchy, tabType, 0)}
                </tbody>
            </table>
        </div>
    `;
}

function organizeHierarchy(items) {
    // Create a map for quick lookup
    const itemMap = new Map();
    const rootItems = [];
    
    // First pass: create map of all items
    items.forEach(item => {
        itemMap.set(item.urn, { ...item, children: [] });
    });
    
    // Second pass: organize into hierarchy
    items.forEach(item => {
        if (item.parent_urn && itemMap.has(item.parent_urn)) {
            // Add to parent's children
            itemMap.get(item.parent_urn).children.push(itemMap.get(item.urn));
        } else {
            // Root level item
            rootItems.push(itemMap.get(item.urn));
        }
    });
    
    return rootItems;
}

function renderHierarchicalItems(items, tabType, level) {
    return items.map(item => {
        const hasChildren = item.children && item.children.length > 0;
        let html = renderGlossaryRow(item, tabType, level, hasChildren);
        
        if (hasChildren) {
            // Add children rows (initially visible)
            html += renderHierarchicalItems(item.children, tabType, level + 1);
        }
        
        return html;
    }).join('');
}

function determineEntityType(item) {
    // First, check if entity_type is already set correctly
    if (item.entity_type === 'glossaryTerm' || item.entity_type === 'glossaryNode') {
        return item.entity_type;
    }
    
    // Check __typename from GraphQL
    if (item.__typename) {
        if (item.__typename === 'GlossaryTerm') return 'glossaryTerm';
        if (item.__typename === 'GlossaryNode') return 'glossaryNode';
    }
    
    // Check URN pattern
    if (item.urn) {
        if (item.urn.includes(':glossaryTerm:')) return 'glossaryTerm';
        if (item.urn.includes(':glossaryNode:')) return 'glossaryNode';
    }
    
    // Check type field
    if (item.type) {
        if (item.type.toLowerCase().includes('term')) return 'glossaryTerm';
        if (item.type.toLowerCase().includes('node')) return 'glossaryNode';
    }
    
    // Check if it has definition (terms usually have definitions, nodes don't)
    if (item.definition || item.termSource) return 'glossaryTerm';
    
    // Check if it has children (nodes usually have children, terms don't)
    if (item.children && item.children.length > 0) return 'glossaryNode';
    
    // Default fallback
    console.warn('Could not determine entity type for item:', item);
    return 'unknown';
}

function renderGlossaryRow(item, tabType, level = 0, hasChildren = false) {
    const statusClass = getStatusBadgeClass(item.sync_status);
    
    // Determine the actual entity type using multiple methods
    const entityType = determineEntityType(item);
    
    // Determine icon and type display based on determined entity type
    let typeIcon, typeDisplay, typeBadgeClass;
    if (entityType === 'glossaryTerm') {
        typeIcon = 'fas fa-bookmark text-success';  // Bookmark icon for terms
        typeDisplay = 'Term';
        typeBadgeClass = 'success';
    } else if (entityType === 'glossaryNode') {
        typeIcon = 'fas fa-folder-open text-primary';  // Folder icon for nodes
        typeDisplay = 'Node';
        typeBadgeClass = 'primary';
    } else {
        typeIcon = 'fas fa-question-circle text-warning';
        typeDisplay = 'Unknown';
        typeBadgeClass = 'warning';
        console.warn('Unknown entity type for item:', item);
    }
    
    // Create indentation for hierarchy
    const indent = level * 20;
    
    return `
        <tr data-item='${JSON.stringify(item)}' data-level="${level}" data-node-urn="${item.urn}" ${item.parent_urn ? `data-parent-node="${item.parent_urn}"` : ''}>
            <td>
                <div class="hierarchy-container" style="margin-left: ${indent}px;">
                    ${level > 0 ? '<div class="tree-connector"></div>' : ''}
                    <div class="expand-button-container">
                        ${hasChildren ? `
                            <button class="expand-button" type="button" title="Expand/Collapse">
                                <i class="fas fa-chevron-down expand-icon" id="icon-${item.urn}"></i>
                            </button>
                        ` : ''}
                    </div>
                    <i class="${typeIcon} me-2" style="font-size: 1.1em;"></i>
                    <span class="item-name">${escapeHtml(item.name || 'Unnamed')}</span>
                </div>
            </td>
            <td>
                <span class="badge bg-${typeBadgeClass}">
                    <i class="${typeIcon.split(' ')[1]} me-1"></i>
                    ${typeDisplay}
                </span>
            </td>
            <td>
                <span title="${escapeHtml(item.description || '')}">${escapeHtml(truncateText(item.description || '', 50))}</span>
            </td>
            <td>
                <code class="small text-truncate d-block" style="max-width: 150px;" title="${escapeHtml(item.urn || '')}">${escapeHtml(truncateUrnFromEnd(item.urn || '', 30))}</code>
            </td>
            <td>
                <span class="badge ${statusClass}">${item.sync_status_display || item.sync_status}</span>
            </td>
            <td>
                ${item.owners_count ? `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users me-1"></i>
                        <span class="badge bg-info">${item.owners_count}</span>
                        ${item.owner_names && item.owner_names.length > 0 ? `
                            <small class="ms-2 text-muted">${item.owner_names.slice(0, 2).join(', ')}${item.owner_names.length > 2 ? '...' : ''}</small>
                        ` : ''}
                    </div>
                ` : `<span class="text-muted">None</span>`}
            </td>
            <td>
                ${item.relationships_count ? `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-project-diagram me-1"></i>
                        <span class="badge bg-secondary">${item.relationships_count}</span>
                    </div>
                ` : `<span class="text-muted">None</span>`}
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary view-item" 
                            title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${item.urn && !item.urn.includes('local:') ? `
                        <a href="${getDataHubUrl(item.urn, entityType)}" 
                           class="btn btn-sm btn-outline-info" 
                           target="_blank" title="View in DataHub">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    ` : ''}
                    ${getActionButtons(item, tabType)}
                </div>
            </td>
        </tr>
    `;
}

function getActionButtons(item, tabType) {
    const hasDataHubConnection = true; // This should come from the template context
    let buttons = '';
    
    if (tabType === 'synced' && item.sync_status === 'MODIFIED' && hasDataHubConnection) {
        const deployUrl = item.type === 'node' ? 
            `/metadata/glossary/nodes/${item.id}/deploy/` : 
            `/metadata/glossary/terms/${item.id}/deploy/`;
        buttons += `
            <form action="${deployUrl}" method="post" class="d-inline">
                <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
                <button type="submit" class="btn btn-sm btn-outline-warning" title="Update in DataHub">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </form>
        `;
    }
    
    if (tabType === 'local' && hasDataHubConnection) {
        const deployUrl = item.type === 'node' ? 
            `/metadata/glossary/nodes/${item.id}/deploy/` : 
            `/metadata/glossary/terms/${item.id}/deploy/`;
        buttons += `
            <form action="${deployUrl}" method="post" class="d-inline">
                <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
                <button type="submit" class="btn btn-sm btn-outline-success" title="Deploy to DataHub">
                    <i class="fas fa-cloud-upload-alt"></i>
                </button>
            </form>
        `;
    }
    
    if (tabType === 'remote') {
        buttons += `
            <form action="/metadata/glossary/pull/" method="post" class="d-inline">
                <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
                <input type="hidden" name="${item.type}_urns" value="${item.urn}">
                <button type="submit" class="btn btn-sm btn-outline-info" title="Import to Local">
                    <i class="fas fa-download"></i>
                </button>
            </form>
        `;
    }
    
    return buttons;
}

function getEmptyStateHTML(tabType, hasSearch) {
    if (hasSearch) {
        return `
            <div class="py-5 text-center">
                <div class="mb-3">
                    <i class="fas fa-search fa-4x text-muted"></i>
                </div>
                <h4>No items found</h4>
                <p class="text-muted">No items match your search criteria.</p>
            </div>
        `;
    }
    
    const emptyStates = {
        synced: {
            icon: 'fas fa-sync-alt',
            title: 'No synced items',
            description: 'Items that exist both locally and in DataHub will appear here.'
        },
        local: {
            icon: 'fas fa-laptop',
            title: 'No local-only items',
            description: 'Items that exist only in this application will appear here.',
            action: `<div class="mt-2">
                        <a href="/metadata/glossary/nodes/create/" class="btn btn-primary me-2">
                            <i class="fas fa-folder-plus me-1"></i> Create Node
                        </a>
                        <a href="/metadata/glossary/terms/create/" class="btn btn-success">
                            <i class="fas fa-tag me-1"></i> Create Term
                        </a>
                     </div>`
        },
        remote: {
            icon: 'fas fa-server',
            title: 'No remote-only items',
            description: 'Items that exist only in DataHub will appear here.'
        }
    };
    
    const state = emptyStates[tabType];
    return `
        <div class="py-5 text-center">
            <div class="mb-3">
                <i class="${state.icon} fa-4x text-muted"></i>
            </div>
            <h4>${state.title}</h4>
            <p class="text-muted">${state.description}</p>
            ${state.action || ''}
        </div>
    `;
}

function showItemDetails(item) {
    // Basic information
    document.getElementById('modal-item-name').textContent = item.name || 'Unnamed';
    
    // Determine the actual entity type
    const entityType = determineEntityType(item);
    
    // Set type with icon
    const typeElement = document.getElementById('modal-item-type');
    if (entityType === 'glossaryTerm') {
        typeElement.innerHTML = '<i class="fas fa-bookmark text-success me-1"></i>Glossary Term';
    } else if (entityType === 'glossaryNode') {
        typeElement.innerHTML = '<i class="fas fa-folder-open text-primary me-1"></i>Glossary Node';
    } else {
        typeElement.innerHTML = `<i class="fas fa-question-circle text-warning me-1"></i>Unknown Type`;
    }
    
    document.getElementById('modal-item-description').textContent = item.description || 'No description available';
    document.getElementById('modal-item-urn').textContent = item.urn || 'No URN available';
    
    // Status
    const statusBadge = document.getElementById('modal-item-status');
    statusBadge.textContent = item.sync_status_display || item.sync_status;
    statusBadge.className = `badge ${getStatusBadgeClass(item.sync_status)}`;
    
    // Parent information
    const parentLabel = document.getElementById('modal-parent-label');
    const parentValue = document.getElementById('modal-parent-value');
    if (item.parent_urn || item.parent_name) {
        parentLabel.style.display = 'block';
        parentValue.style.display = 'block';
        document.getElementById('modal-item-parent').innerHTML = `
            ${item.parent_name ? `<strong>${escapeHtml(item.parent_name)}</strong><br>` : ''}
            ${item.parent_urn ? `<code class="small">${escapeHtml(item.parent_urn)}</code>` : ''}
        `;
    } else {
        parentLabel.style.display = 'block';
        parentValue.style.display = 'block';
        document.getElementById('modal-item-parent').innerHTML = '<span class="text-muted">Root Level</span>';
    }
    
    // DataHub link
    const datahubLink = document.getElementById('modal-datahub-link');
    if (item.urn && !item.urn.includes('local:') && glossaryData.datahub_url) {
        datahubLink.href = getDataHubUrl(item.urn, item.entity_type);
        datahubLink.style.display = 'inline-block';
    } else {
        datahubLink.style.display = 'none';
    }
    
    // Ownership information
    const ownersList = document.getElementById('modal-owners-list');
    if (item.ownership && item.ownership.owners && item.ownership.owners.length > 0) {
        ownersList.innerHTML = item.ownership.owners.map(ownerInfo => {
            const owner = ownerInfo.owner || {};
            const ownershipType = ownerInfo.ownershipType || {};
            const source = ownerInfo.source || {};
            
            const displayName = owner.properties ? 
                (owner.properties.displayName || owner.properties.fullName || owner.username || owner.name) :
                (owner.username || owner.name || 'Unknown');
                
            return `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${escapeHtml(displayName)}</strong>
                            <br>
                            <small class="text-muted">${escapeHtml(ownershipType.info ? ownershipType.info.name : 'Owner')}</small>
                        </div>
                        <div class="text-end">
                            ${source.type ? `<span class="badge bg-light text-dark">${source.type}</span>` : ''}
                        </div>
                    </div>
                    <div class="mt-1">
                        <code class="small">${escapeHtml(owner.urn || '')}</code>
                    </div>
                    ${owner.properties && (owner.properties.email || owner.properties.title) ? `
                        <div class="mt-2">
                            ${owner.properties.email ? `<small class="text-muted d-block"><i class="fas fa-envelope me-1"></i>${escapeHtml(owner.properties.email)}</small>` : ''}
                            ${owner.properties.title ? `<small class="text-muted d-block"><i class="fas fa-briefcase me-1"></i>${escapeHtml(owner.properties.title)}</small>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    } else {
        ownersList.innerHTML = '<p class="text-muted">No ownership information available</p>';
    }
    
    // Last modified information
    const lastModifiedDiv = document.getElementById('modal-last-modified');
    if (item.ownership && item.ownership.lastModified) {
        lastModifiedDiv.innerHTML = `
            <div class="border rounded p-2">
                <strong>Last Modified:</strong><br>
                <small class="text-muted">
                    ${formatDate(item.ownership.lastModified.time)}
                    ${item.ownership.lastModified.actor ? ` by ${item.ownership.lastModified.actor}` : ''}
                </small>
            </div>
        `;
    } else if (item.lastModified) {
        lastModifiedDiv.innerHTML = `
            <div class="border rounded p-2">
                <strong>Last Modified:</strong><br>
                <small class="text-muted">${formatDate(item.lastModified.time)}</small>
            </div>
        `;
    } else {
        lastModifiedDiv.innerHTML = '';
    }
    
    // Relationships
    const relationshipsList = document.getElementById('modal-relationships-list');
    if (item.relationships && item.relationships.relationships && item.relationships.relationships.length > 0) {
        relationshipsList.innerHTML = item.relationships.relationships.map(rel => `
            <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${escapeHtml(rel.type || 'Unknown')}</strong>
                        <span class="badge bg-${rel.direction === 'INCOMING' ? 'success' : 'primary'} ms-2">
                            ${rel.direction || 'UNKNOWN'}
                        </span>
                    </div>
                    <div class="text-end">
                        ${rel.created ? `<small class="text-muted">${formatDate(rel.created.time)}</small>` : ''}
                    </div>
                </div>
                <div class="mt-1">
                    <code class="small">${escapeHtml(rel.entity ? rel.entity.urn : 'No entity URN')}</code>
                </div>
                ${rel.entity && rel.entity.properties ? `
                    <div class="mt-1">
                        <small class="text-muted">${escapeHtml(rel.entity.properties.name || 'Unknown Entity')}</small>
                    </div>
                ` : ''}
            </div>
        `).join('');
    } else {
        relationshipsList.innerHTML = '<p class="text-muted">No relationships available</p>';
    }
    
    // Glossary-specific properties
    const propertiesDiv = document.getElementById('modal-glossary-properties');
    if (item.properties || item.institutionalMemory || item.definition) {
        let propertiesHTML = '';
        
        // Definition (for terms)
        if (item.definition) {
            propertiesHTML += `
                <div class="border rounded p-2 mb-2">
                    <strong>Definition:</strong>
                    <div class="mt-2">${escapeHtml(item.definition)}</div>
                </div>
            `;
        }
        
        // Term Source (for terms)
        if (item.termSource) {
            propertiesHTML += `
                <div class="border rounded p-2 mb-2">
                    <strong>Term Source:</strong>
                    <div class="mt-2">${escapeHtml(item.termSource)}</div>
                </div>
            `;
        }
        
        // Custom Properties
        if (item.properties && item.properties.customProperties) {
            propertiesHTML += `
                <div class="border rounded p-2 mb-2">
                    <strong>Custom Properties:</strong>
                    <pre class="mt-2 mb-0"><code>${escapeHtml(JSON.stringify(item.properties.customProperties, null, 2))}</code></pre>
                </div>
            `;
        }
        
        // Institutional Memory
        if (item.institutionalMemory && item.institutionalMemory.elements && item.institutionalMemory.elements.length > 0) {
            propertiesHTML += `
                <div class="border rounded p-2 mb-2">
                    <strong>Institutional Memory:</strong>
                    ${item.institutionalMemory.elements.map(elem => `
                        <div class="mt-2">
                            <a href="${escapeHtml(elem.url)}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-external-link-alt me-1"></i>
                                ${escapeHtml(elem.description || elem.url)}
                            </a>
                            ${elem.createStamp ? `<br><small class="text-muted">Added: ${formatDate(elem.createStamp.time)}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        propertiesDiv.innerHTML = propertiesHTML;
    } else {
        propertiesDiv.innerHTML = '<p class="text-muted">No additional properties available</p>';
    }
    
    // Raw JSON - Show comprehensive GraphQL data
    const rawData = item.raw_data || item;
    document.getElementById('modal-raw-json').innerHTML = `<code>${escapeHtml(JSON.stringify(rawData, null, 2))}</code>`;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('itemViewModal')).show();
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

function truncateUrnFromEnd(urn, maxLength) {
    if (!urn || urn.length <= maxLength) return urn;
    
    // Keep the beginning of the URN and truncate from the end
    return urn.substring(0, maxLength - 3) + '...';
}

function formatDate(timestamp) {
    try {
        const date = new Date(parseInt(timestamp));
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    } catch (e) {
        return timestamp;
    }
}

function getDataHubUrl(urn, type) {
    if (glossaryData.datahub_url) {
        const entityType = type === 'node' ? 'glossaryNode' : 'glossaryTerm';
        return `${glossaryData.datahub_url}/${entityType}/${encodeURIComponent(urn)}`;
    }
    return '#';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'SYNCED': return 'bg-success';
        case 'MODIFIED': return 'bg-warning';
        case 'LOCAL_ONLY': return 'bg-secondary';
        case 'REMOTE_ONLY': return 'bg-info';
        default: return 'bg-primary';
    }
}

function getCsrfToken() {
    const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfElement ? csrfElement.value : '';
}

function showError(message) {
    // Create and show error alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
}

// Expand/collapse functionality
function toggleNodeChildren(nodeUrn) {
    console.log('Toggling children for node:', nodeUrn);
    
    const expandIcon = document.getElementById(`icon-${nodeUrn}`);
    const childRows = document.querySelectorAll(`[data-parent-node="${nodeUrn}"]`);
    
    if (!expandIcon) {
        console.error('Expand icon not found for node:', nodeUrn);
        return;
    }
    
    const isCollapsed = expandIcon.classList.contains('fa-chevron-right');
    
    if (isCollapsed) {
        // Expand: show direct children only
        expandIcon.classList.remove('fa-chevron-right');
        expandIcon.classList.add('fa-chevron-down');
        childRows.forEach(row => {
            row.style.display = 'table-row';
        });
    } else {
        // Collapse: hide all descendants recursively
        expandIcon.classList.remove('fa-chevron-down');
        expandIcon.classList.add('fa-chevron-right');
        
        // Recursively collapse all descendants
        collapseAllDescendants(nodeUrn);
    }
}

function collapseAllDescendants(parentUrn) {
    // Find all direct children
    const childRows = document.querySelectorAll(`[data-parent-node="${parentUrn}"]`);
    
    childRows.forEach(row => {
        // Hide the row
        row.style.display = 'none';
        
        // Get the URN of this child
        const childUrn = row.dataset.nodeUrn;
        
        // Collapse the expand icon if it has one
        const childExpandIcon = document.getElementById(`icon-${childUrn}`);
        if (childExpandIcon) {
            childExpandIcon.classList.remove('fa-chevron-down');
            childExpandIcon.classList.add('fa-chevron-right');
        }
        
        // Recursively collapse this child's descendants
        if (childUrn) {
            collapseAllDescendants(childUrn);
        }
    });
}

// Expand all nodes
function expandAllNodes() {
    const allExpandIcons = document.querySelectorAll('.expand-icon');
    allExpandIcons.forEach(icon => {
        if (icon.classList.contains('fa-chevron-right')) {
            const nodeUrn = icon.id.replace('icon-', '');
            // Only expand, don't toggle
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
            const childRows = document.querySelectorAll(`[data-parent-node="${nodeUrn}"]`);
            childRows.forEach(row => {
                row.style.display = 'table-row';
            });
        }
    });
}

// Collapse all nodes
function collapseAllNodes() {
    const allExpandIcons = document.querySelectorAll('.expand-icon');
    allExpandIcons.forEach(icon => {
        if (icon.classList.contains('fa-chevron-down')) {
            const nodeUrn = icon.id.replace('icon-', '');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
            // Use the recursive collapse function
            collapseAllDescendants(nodeUrn);
        }
    });
}
</script>

<style>
#modal-raw-json {
    max-height: 300px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
}
</style>
{% endblock %} 