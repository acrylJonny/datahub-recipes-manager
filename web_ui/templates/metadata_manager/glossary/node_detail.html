{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <span class="badge glossary-node-badge">
                <i class="fas fa-folder me-1 text-warning"></i> {{ node.name }}
            </span>
        </h1>
        <div class="d-flex gap-2">
            {% if node.can_deploy and has_datahub_connection %}
            <form method="post" action="{% url 'metadata_manager:glossary_node_deploy' node.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="redirect_url" value="{% url 'metadata_manager:glossary_node_detail' node.id %}">
                <button type="submit" class="btn btn-primary" onclick="return confirm('Deploy this node to DataHub?')">
                    <i class="fas fa-cloud-upload-alt me-1"></i> Deploy to DataHub
                </button>
            </form>
            {% endif %}
            
            {% if node.is_local and has_git_integration %}
            <button type="button" class="btn btn-outline-primary add-node-to-git-pr" data-node-id="{{ node.id }}">
                <i class="fab fa-github me-1"></i> Add to Git PR
            </button>
            {% endif %}
            
            <a href="{% url 'metadata_manager:glossary_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Glossary
            </a>
        </div>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Node Status Badge -->
    <div class="mb-4">
        <span class="badge bg-{% if node.is_synced %}success{% else %}warning{% endif %} p-2">
            <i class="fas {% if node.is_synced %}fa-check-circle{% else %}fa-sync{% endif %} me-1"></i>
            {{ node.get_sync_status_display }}
        </span>
        
        {% if node.last_synced %}
        <span class="text-muted ms-2">Last synced: {{ node.last_synced|date:"Y-m-d H:i" }}</span>
        {% endif %}
        
        {% if node.staged_for_git %}
        <span class="badge bg-primary ms-2">
            <i class="fab fa-github me-1"></i> Staged for Git
        </span>
        {% endif %}
    </div>
    
    <div class="card">
        <div class="card-body">
            <!-- Node Details Tabs -->
            <ul class="nav nav-tabs mb-4" id="nodeDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" 
                           type="button" role="tab" aria-controls="details" aria-selected="true">
                        <i class="fas fa-info-circle me-1"></i> Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="children-tab" data-bs-toggle="tab" data-bs-target="#children" 
                           type="button" role="tab" aria-controls="children" aria-selected="false">
                        <i class="fas fa-sitemap me-1"></i> Children
                        <span class="badge bg-primary ms-1">{{ node.children.count|add:node.terms.count }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="owners-tab" data-bs-toggle="tab" data-bs-target="#owners" 
                           type="button" role="tab" aria-controls="owners" aria-selected="false">
                        <i class="fas fa-users me-1"></i> Owners
                        <span class="badge bg-primary ms-1">{{ node.owners.count }}</span>
                    </button>
                </li>
                {% if remote_node %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote" 
                           type="button" role="tab" aria-controls="remote" aria-selected="false">
                        <i class="fas fa-server me-1"></i> Remote
                    </button>
                </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="save-options-tab" data-bs-toggle="tab" data-bs-target="#save-options" 
                           type="button" role="tab" aria-controls="save-options" aria-selected="false">
                        <i class="fas fa-save me-1"></i> Save Options
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="nodeDetailTabsContent">
                <!-- Details Tab -->
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <form method="post" action="{% url 'metadata_manager:glossary_node_detail' node.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ node.name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="parent_node_id" class="form-label">Parent Node</label>
                                    <select class="form-select" id="parent_node_id" name="parent_node_id">
                                        <option value="">No parent (root node)</option>
                                        {% for other_node in available_parent_nodes %}
                                            {% if other_node.id != node.id %}
                                            <option value="{{ other_node.id }}" {% if node.parent_node and node.parent_node.id == other_node.id %}selected{% endif %}>{{ other_node.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">URN</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" value="{{ node.deterministic_urn }}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ node.deterministic_urn }}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    {% if node.original_urn and node.original_urn != node.deterministic_urn %}
                                    <small class="text-muted">Original URN: {{ node.original_urn }}</small>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Statistics</label>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <strong>Child Nodes:</strong> {{ node.children.count }}
                                                </div>
                                                <div class="col-6">
                                                    <strong>Terms:</strong> {{ node.terms.count }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="5">{{ node.description }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="color_hex" class="form-label">Color (Hex)</label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color" id="color_picker" 
                                       value="{{ node.color_hex|default:'#007bff' }}" title="Choose color">
                                <input type="text" class="form-control" id="color_hex" name="color_hex" 
                                       value="{{ node.color_hex|default:'' }}" placeholder="#RRGGBB">
                                <button class="btn btn-outline-secondary" type="button" id="apply_color">Apply</button>
                            </div>
                            <small class="form-text text-muted">Color used for visual display in DataHub UI (may require database schema update)</small>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteNodeModal">
                                <i class="fas fa-trash-alt me-1"></i> Delete Node
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Children Tab -->
                <div class="tab-pane fade" id="children" role="tabpanel" aria-labelledby="children-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Child Nodes</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createChildNodeModal">
                            <i class="fas fa-folder-plus me-1"></i> Add Child Node
                        </button>
                    </div>
                    
                    {% if node.children.exists %}
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for child in node.children.all %}
                                <tr>
                                    <td>
                                        <a href="{% url 'metadata_manager:glossary_node_detail' child.id %}">
                                            <i class="fas fa-folder text-warning me-1"></i> {{ child.name }}
                                        </a>
                                    </td>
                                    <td>{{ child.description|truncatechars:100 }}</td>
                                    <td>
                                        <span class="badge bg-{% if child.is_synced %}success{% else %}warning{% endif %}">
                                            {{ child.get_sync_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'metadata_manager:glossary_node_detail' child.id %}" class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger delete-child-node" 
                                                   data-bs-toggle="modal" data-bs-target="#deleteChildNodeModal"
                                                   data-node-id="{{ child.id }}" data-node-name="{{ child.name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i> This node has no child nodes.
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Terms</h5>
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#createTermModal">
                            <i class="fas fa-tag me-1"></i> Add Term
                        </button>
                    </div>
                    
                    {% if node.terms.exists %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for term in node.terms.all %}
                                <tr>
                                    <td>
                                        <a href="{% url 'metadata_manager:glossary_term_detail' term.id %}">
                                            <i class="fas fa-tag text-info me-1"></i> {{ term.name }}
                                        </a>
                                    </td>
                                    <td>{{ term.description|truncatechars:100 }}</td>
                                    <td>
                                        <span class="badge bg-{% if term.is_synced %}success{% else %}warning{% endif %}">
                                            {{ term.get_sync_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'metadata_manager:glossary_term_detail' term.id %}" class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger delete-term" 
                                                   data-bs-toggle="modal" data-bs-target="#deleteTermModal"
                                                   data-term-id="{{ term.id }}" data-term-name="{{ term.name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i> This node has no terms.
                    </div>
                    {% endif %}
                </div>
                
                <!-- Owners Tab -->
                <div class="tab-pane fade" id="owners" role="tabpanel" aria-labelledby="owners-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Node Owners</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addOwnerModal">
                            <i class="fas fa-user-plus me-1"></i> Add Owner
                        </button>
                    </div>
                    
                    {% if node.owners.exists %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Owner</th>
                                    <th>Type</th>
                                    <th width="10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for owner in node.owners.all %}
                                <tr>
                                    <td>
                                        <i class="fas {% if owner.owner_type == 'CORP_USER' %}fa-user{% elif owner.owner_type == 'CORP_GROUP' %}fa-users{% else %}fa-building{% endif %} me-1"></i>
                                        {{ owner.owner_id }}
                                    </td>
                                    <td>{{ owner.get_owner_type_display }}</td>
                                    <td>
                                        <form action="{% url 'metadata_manager:glossary_node_detail' node.id %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="remove_owner">
                                            <input type="hidden" name="owner_id" value="{{ owner.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                   onclick="return confirm('Remove this owner?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i> This node has no owners.
                    </div>
                    {% endif %}
                </div>
                
                {% if remote_node %}
                <!-- Remote Tab -->
                <div class="tab-pane fade" id="remote" role="tabpanel" aria-labelledby="remote-tab">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-1"></i>
                        This shows the node as it currently exists on the DataHub server.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" value="{{ remote_node.name }}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">URN</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ remote_node.urn }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ remote_node.urn }}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Parent Node</label>
                                <input type="text" class="form-control" value="{{ remote_node.parent_name|default:'No parent (root node)' }}" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="5" readonly>{{ remote_node.description }}</textarea>
                    </div>
                </div>
                {% endif %}
                
                <!-- Save Options Tab -->
                <div class="tab-pane fade" id="save-options" role="tabpanel" aria-labelledby="save-options-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">DataHub Server</h5>
                                </div>
                                <div class="card-body">
                                    <p>Deploy this node to the DataHub server.</p>
                                    {% if node.can_deploy and has_datahub_connection %}
                                    <form method="post" action="{% url 'metadata_manager:glossary_node_deploy' node.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="redirect_url" value="{% url 'metadata_manager:glossary_node_detail' node.id %}">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-cloud-upload-alt me-1"></i> Deploy to DataHub
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="btn btn-primary" disabled>
                                        <i class="fas fa-cloud-upload-alt me-1"></i> Deploy to DataHub
                                    </button>
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {% if not has_datahub_connection %}
                                        Not connected to DataHub.
                                        {% else %}
                                        Node is already synced with the server.
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">GitHub Integration</h5>
                                </div>
                                <div class="card-body">
                                    <p>Add this node to a GitHub PR for version control.</p>
                                    
                                    {% if has_git_integration %}
                                    <form id="gitHubPushForm" data-node-id="{{ node.id }}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="environment_id" class="form-label">Target Environment (Optional)</label>
                                            <select class="form-select" id="environment_id" name="environment_id">
                                                <option value="">No environment (default)</option>
                                                {% for env in environments %}
                                                <option value="{{ env.id }}">{{ env.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <button type="button" class="btn btn-outline-primary" id="addToGitPRBtn">
                                            <i class="fab fa-github me-1"></i> Add to GitHub PR
                                        </button>
                                    </form>
                                    <div id="gitPushResult" class="mt-3"></div>
                                    {% else %}
                                    <button class="btn btn-outline-primary" disabled>
                                        <i class="fab fa-github me-1"></i> Add to GitHub PR
                                    </button>
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        GitHub integration is not enabled.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Node Modal -->
<div class="modal fade" id="deleteNodeModal" tabindex="-1" aria-labelledby="deleteNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteNodeModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the node <strong>{{ node.name }}</strong>?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Warning: This will also delete all child nodes and terms!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{% url 'metadata_manager:glossary_node_detail' node.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger">Delete Node</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Owner Modal -->
<div class="modal fade" id="addOwnerModal" tabindex="-1" aria-labelledby="addOwnerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOwnerModalLabel">Add Owner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'metadata_manager:glossary_node_detail' node.id %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_owner">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="owner_id" class="form-label">Owner ID</label>
                        <input type="text" class="form-control" id="owner_id" name="owner_id" required>
                        <div class="form-text">For users, use their LDAP username</div>
                    </div>
                    <div class="mb-3">
                        <label for="owner_type" class="form-label">Owner Type</label>
                        <select class="form-select" id="owner_type" name="owner_type" required>
                            <option value="CORP_USER">User</option>
                            <option value="CORP_GROUP">Group</option>
                            <option value="CORP_TEAM">Team</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Owner</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Child Node Modal -->
<div class="modal fade" id="deleteChildNodeModal" tabindex="-1" aria-labelledby="deleteChildNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChildNodeModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the node <strong id="deleteChildNodeName"></strong>?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Warning: This will also delete all its child nodes and terms!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteChildNodeForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger">Delete Node</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Term Modal -->
<div class="modal fade" id="deleteTermModal" tabindex="-1" aria-labelledby="deleteTermModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTermModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the term <strong id="deleteTermName"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteTermForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger">Delete Term</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create Child Node Modal -->
<div class="modal fade" id="createChildNodeModal" tabindex="-1" aria-labelledby="createChildNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createChildNodeModalLabel">Create Child Node</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'metadata_manager:glossary_node_create' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="parent_node_id" value="{{ node.id }}">
                <input type="hidden" name="redirect_url" value="{% url 'metadata_manager:glossary_node_detail' node.id %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_node_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="new_node_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_node_description" class="form-label">Description</label>
                        <textarea class="form-control" id="new_node_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Node</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Term Modal -->
<div class="modal fade" id="createTermModal" tabindex="-1" aria-labelledby="createTermModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTermModalLabel">Create Term</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'metadata_manager:glossary_term_create' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="parent_node_id" value="{{ node.id }}">
                <input type="hidden" name="redirect_url" value="{% url 'metadata_manager:glossary_node_detail' node.id %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new_term_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="new_term_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_term_description" class="form-label">Description</label>
                        <textarea class="form-control" id="new_term_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Term</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle child node deletion
    document.querySelectorAll('.delete-child-node').forEach(button => {
        button.addEventListener('click', function() {
            const nodeId = this.getAttribute('data-node-id');
            const nodeName = this.getAttribute('data-node-name');
            
            document.getElementById('deleteChildNodeName').textContent = nodeName;
            document.getElementById('deleteChildNodeForm').action = "{% url 'metadata_manager:glossary_node_detail' 0 %}".replace('0', nodeId);
        });
    });
    
    // Handle term deletion
    document.querySelectorAll('.delete-term').forEach(button => {
        button.addEventListener('click', function() {
            const termId = this.getAttribute('data-term-id');
            const termName = this.getAttribute('data-term-name');
            
            document.getElementById('deleteTermName').textContent = termName;
            document.getElementById('deleteTermForm').action = "{% url 'metadata_manager:glossary_term_detail' 0 %}".replace('0', termId);
        });
    });
    
    // GitHub integration if enabled
    const addToGitPRBtn = document.getElementById('addToGitPRBtn');
    if (addToGitPRBtn) {
        addToGitPRBtn.addEventListener('click', function() {
            const form = document.getElementById('gitHubPushForm');
            const nodeId = form.getAttribute('data-node-id');
            const environmentId = document.getElementById('environment_id').value;
            const resultDiv = document.getElementById('gitPushResult');
            
            resultDiv.innerHTML = '<div class="alert alert-info">Adding to GitHub PR...</div>';
            
            fetch("{% url 'metadata_manager:glossary_node_push_github' 0 %}".replace('0', nodeId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'environment_id': environmentId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        });
    }
    
    // Color picker syncing
    const colorPicker = document.getElementById('color_picker');
    const colorHexInput = document.getElementById('color_hex');
    const applyColorBtn = document.getElementById('apply_color');
    
    if (colorPicker && colorHexInput) {
        colorPicker.addEventListener('input', function() {
            colorHexInput.value = this.value;
        });
        
        colorHexInput.addEventListener('input', function() {
            const hexValue = this.value;
            if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                colorPicker.value = hexValue;
            }
        });
        
        if (applyColorBtn) {
            applyColorBtn.addEventListener('click', function() {
                colorHexInput.value = colorPicker.value;
            });
        }
        
        // Make sure we have a valid initial color
        if (colorHexInput.value && /^#[0-9A-F]{6}$/i.test(colorHexInput.value)) {
            colorPicker.value = colorHexInput.value;
        } else if (colorPicker.value) {
            colorHexInput.value = colorPicker.value;
        } else {
            // Set default color if none is provided
            const defaultColor = '#007bff';
            colorPicker.value = defaultColor;
            colorHexInput.value = defaultColor;
        }
    }
});
</script>
{% endblock %} 