{% extends "base.html" %}
{% load static %}
{% load metadata_manager_filters %}

{% block title %}DataHub Data Products{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    .description-cell {
        max-width: 300px;
        word-wrap: break-word;
        white-space: normal;
    }
    
    .description-preview {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: 4.2em; /* 3 lines * 1.4 line-height */
    }
    
    .related-items-cell {
        max-width: 250px;
    }
    
    .relationship-badge {
        font-size: 0.7rem;
        margin: 0.1rem;
        padding: 0.2rem 0.4rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tab-loading {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    
    .table-responsive {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
    
    /* Modal enhancements */
    .modal-body dl {
        margin-bottom: 0;
    }
    
    .modal-body dt {
        font-weight: 600;
        color: #495057;
        margin-top: 1rem;
    }
    
    .modal-body dt:first-child {
        margin-top: 0;
    }
    
    .modal-body dd {
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
    
    .relationship-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        padding: 0.25rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    
    .owner-item {
        display: inline-block;
        margin: 0.1rem;
        padding: 0.2rem 0.5rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
    }
    
    .clickable-stat {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .clickable-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .clickable-stat.active {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Tighter spacing for statistics rows */
    .row.g-1.mb-1 {
        margin-bottom: 3px !important;
    }
    
    /* Bulk Actions Styling */
    .bulk-actions {
        display: none;
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .bulk-actions.show {
        display: block !important;
    }

    /* Unified Filter Statistics Styling */
    .filter-row {
        min-height: 70px;
    }
    
    .filter-stat {
        cursor: pointer;
        transition: all 0.2s ease;
        border-right: 1px solid #e9ecef;
        padding: 1rem 0.5rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 70px;
    }
    
    .filter-stat:last-child {
        border-right: none;
    }
    
    .filter-stat:hover {
        background-color: #f8f9fa;
    }
    
    /* Single-select (overview row) */
    .clickable-stat:not(.multi-select).active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    /* Multi-select styling */
    .multi-select.active {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .clickable-stat.active .text-muted {
        color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .clickable-stat.active .text-success,
    .clickable-stat.active .text-danger, 
    .clickable-stat.active .text-warning {
        color: white !important;
    }
    
    /* Row label styling */
    .filter-row .bg-light {
        font-weight: 600;
        background-color: #f8f9fa !important;
    }
    
    /* Larger text for better readability */
    .filter-stat .h5 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .filter-stat .h6 {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .filter-stat .text-muted {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    /* Make row headers bigger */
    .filter-row .bg-light {
        font-weight: 600;
        background-color: #f8f9fa !important;
        font-size: 1.2rem !important;
    }
    
    /* Ensure table has horizontal scrolling */
    .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* Pagination styling */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .pagination-info {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .pagination .page-link {
        color: #007bff;
        border-color: #dee2e6;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white !important;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        cursor: auto;
        background-color: #fff;
        border-color: #dee2e6;
    }
    
    /* Bulk selection styling */
    .bulk-actions-bar {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .bulk-actions-bar.show {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .selection-info {
        font-weight: 500;
        color: #495057;
    }
    
    .bulk-actions-bar .bulk-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Checkbox styling */
    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .select-all-checkbox {
        margin-right: 0.5rem;
    }
    
    /* Table checkbox column */
    .checkbox-column {
        width: 40px;
        text-align: center;
    }
    
    /* Action buttons styling */
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    /* Dropdown for create data product */
    .create-data-product-dropdown .dropdown-menu {
        min-width: 200px;
    }
    
    /* Custom column width for overview statistics */
    .col-md-2-5 {
        flex: 0 0 20%;
        max-width: 20%;
    }
    
    /* Overview navigation */
    .clickable-stat.active {
        background-color: #007bff !important;
        color: white !important;
    }
    
    .clickable-stat.active .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hidden CSRF token for JavaScript -->
    <form style="display: none;">
        {% csrf_token %}
    </form>
    
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>DataHub Data Products</h1>
                <div class="d-flex gap-2">
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDataProductModal">
                        <i class="fas fa-plus me-1"></i> Create Data Product
                    </a>
                    <!-- Global Actions Dropdown -->
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sync-alt me-1"></i> Bulk Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="resyncAllProducts()">
                                <i class="fas fa-sync-alt me-2"></i> Resync All
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportAllProducts()">
                                <i class="fas fa-file-export me-2"></i> Export All
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="addAllProductsToStagedChanges()">
                                <i class="fab fa-github me-2"></i> Add All to Staged Changes
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="showImportProductsModal()">
                                <i class="fas fa-file-import me-2"></i> Import from JSON
                            </a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-outline-info" id="refreshProducts">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
            
            {% if not has_datahub_connection %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Not connected to DataHub. Please check your connection settings.
                    <a href="{% url 'settings' %}" class="btn btn-sm btn-warning ms-2">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </div>
            {% endif %}
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Loading indicator -->
            <div id="loading-indicator" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading data products data...</p>
            </div>

            <!-- Data Products content -->
            <div id="products-content" style="display: none;">
                <!-- Statistics Filter Bar -->
                <div class="mb-3">
                    <div class="card">
                        <div class="card-body p-0">
                            <!-- Row 1: Overview -->
                            <div class="row g-0 filter-row">
                                <div class="col-md-2 d-flex align-items-center justify-content-center bg-light border-end">
                                    <strong class="text-muted">Overview</strong>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center" data-filter="total" data-category="overview">
                                        <div class="h5 mb-0" id="total-items">0</div>
                                        <div class="text-muted">Total</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center clickable-stat" data-filter="synced" data-category="overview">
                                        <div class="h5 mb-0" id="synced-count">0</div>
                                        <div class="text-muted">Synced</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center clickable-stat" data-filter="local-only" data-category="overview">
                                        <div class="h5 mb-0" id="local-count">0</div>
                                        <div class="text-muted">Local Only</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5">
                                    <div class="filter-stat text-center clickable-stat" data-filter="remote-only" data-category="overview">
                                        <div class="h5 mb-0" id="remote-count">0</div>
                                        <div class="text-muted">Remote Only</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 2: Content Filters -->
                            <div class="row g-0 filter-row border-top">
                                <div class="col-md-2 d-flex align-items-center justify-content-center bg-light border-end">
                                    <strong class="text-muted">Filters</strong>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center clickable-stat multi-select" data-filter="has-entities" data-category="content">
                                        <div class="h6 mb-0" id="products-with-entities">0</div>
                                        <div class="text-muted">With Entities</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center clickable-stat multi-select" data-filter="has-owners" data-category="content">
                                        <div class="h6 mb-0" id="products-with-owners">0</div>
                                        <div class="text-muted">With Owners</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5 border-end">
                                    <div class="filter-stat text-center clickable-stat multi-select" data-filter="has-domain" data-category="content">
                                        <div class="h6 mb-0" id="products-with-domain">0</div>
                                        <div class="text-muted">With Domain</div>
                                    </div>
                                </div>
                                <div class="col-md-2-5">
                                    <div class="filter-stat text-center clickable-stat multi-select" data-filter="has-external-url" data-category="content">
                                        <div class="h6 mb-0" id="products-with-external-url">0</div>
                                        <div class="text-muted">With External URL</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

            
                <!-- Products Tabs -->
                <ul class="nav nav-tabs mb-4" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="synced-tab" data-bs-toggle="tab" data-bs-target="#synced-items" 
                               type="button" role="tab" aria-controls="synced-items" aria-selected="true">
                            <i class="fas fa-sync-alt me-1"></i> Synced Products
                            <span class="badge bg-success ms-1" id="synced-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-items" 
                               type="button" role="tab" aria-controls="local-items" aria-selected="false">
                            <i class="fas fa-laptop me-1"></i> Local Only Products
                            <span class="badge bg-secondary ms-1" id="local-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote-items" 
                               type="button" role="tab" aria-controls="remote-items" aria-selected="false">
                            <i class="fas fa-server me-1"></i> Remote Only Products
                            <span class="badge bg-info ms-1" id="remote-badge">0</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="productTabsContent">
                    <!-- Synced Products Tab -->
                    <div class="tab-pane fade show active" id="synced-items" role="tabpanel" aria-labelledby="synced-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Synced Products</h5>
                                <div class="input-group" style="width: 300px;">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="synced-search" class="form-control" placeholder="Search synced products...">
                                    <button type="button" class="btn btn-outline-secondary" id="synced-clear">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bulk Actions -->
                            <div id="synced-bulk-actions" class="bulk-actions">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><span id="synced-selected-count">0</span></strong> product(s) selected
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Bulk actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkResyncProducts('synced')">
                                            <i class="fas fa-sync-alt me-1"></i> Bulk Resync
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkSyncToDataHub('synced')">
                                            <i class="fas fa-upload me-1"></i> Bulk Push
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="bulkDownloadJson('synced')">
                                            <i class="fas fa-file-download me-1"></i> Bulk Download
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkAddToPR('synced')">
                                            <i class="fab fa-github me-1"></i> Bulk Add to Staged Changes
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDeleteLocal('synced')">
                                            <i class="fas fa-trash me-1"></i> Delete Local
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body p-0" id="synced-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Local Products Tab -->
                    <div class="tab-pane fade" id="local-items" role="tabpanel" aria-labelledby="local-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Local Only Products</h5>
                                <div class="input-group" style="width: 300px;">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="local-search" class="form-control" placeholder="Search local products...">
                                    <button type="button" class="btn btn-outline-secondary" id="local-clear">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bulk Actions -->
                            <div id="local-bulk-actions" class="bulk-actions">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><span id="local-selected-count">0</span></strong> product(s) selected
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Bulk actions">
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkSyncToDataHub('local')">
                                            <i class="fas fa-upload me-1"></i> Bulk Sync to DataHub
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="bulkDownloadJson('local')">
                                            <i class="fas fa-file-download me-1"></i> Bulk Download
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkAddToPR('local')">
                                            <i class="fab fa-github me-1"></i> Bulk Add to Staged Changes
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDeleteLocal('local')">
                                            <i class="fas fa-trash me-1"></i> Delete Local
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body p-0" id="local-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Remote Products Tab -->
                    <div class="tab-pane fade" id="remote-items" role="tabpanel" aria-labelledby="remote-tab">
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Remote Only Products</h5>
                                <div class="input-group" style="width: 300px;">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="remote-search" class="form-control" placeholder="Search remote products...">
                                    <button type="button" class="btn btn-outline-secondary" id="remote-clear">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bulk Actions -->
                            <div id="remote-bulk-actions" class="bulk-actions">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><span id="remote-selected-count">0</span></strong> product(s) selected
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Bulk actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkSyncToLocal('remote')">
                                            <i class="fas fa-download me-1"></i> Bulk Sync to Local
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="bulkDownloadJson('remote')">
                                            <i class="fas fa-file-download me-1"></i> Bulk Download
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkAddToPR('remote')">
                                            <i class="fab fa-github me-1"></i> Bulk Add to Staged Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body p-0" id="remote-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


                </div>
                
                <!-- Entities -->

                

                


<!-- View Data Product Modal -->
<div class="modal fade" id="viewDataProductModal" tabindex="-1" aria-labelledby="viewDataProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDataProductModalLabel">Data Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Basic Information -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-4">Name:</dt>
                                    <dd class="col-sm-8" id="modal-product-name">-</dd>
                                    
                                    <dt class="col-sm-4">Description:</dt>
                                    <dd class="col-sm-8" id="modal-product-description">-</dd>
                                    
                                    <dt class="col-sm-4">Domain:</dt>
                                    <dd class="col-sm-8" id="modal-product-domain">-</dd>
                                    
                                    <dt class="col-sm-4">External URL:</dt>
                                    <dd class="col-sm-8" id="modal-product-external-url">-</dd>
                                    
                                    <dt class="col-sm-4">Status:</dt>
                                    <dd class="col-sm-8">
                                        <span id="modal-product-status" class="badge">-</span>
                                    </dd>
                                    
                                    <dt class="col-sm-4">URN:</dt>
                                    <dd class="col-sm-8">
                                        <code id="modal-product-urn" class="small">-</code>
                                    </dd>
                                </dl>
                                
                                <div class="mt-3">
                                    <a href="#" id="modal-datahub-link" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-external-link-alt me-1"></i> View in DataHub
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ownership Information -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-users me-2"></i>Ownership</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-owners-list">
                                    <p class="text-muted">No ownership information available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Entities Information -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-database me-2"></i>Entities</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-entities-list">
                                    <p class="text-muted">No entities assigned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tags and Glossary Terms -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-tags me-2"></i>Tags</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-tags-list">
                                    <p class="text-muted">No tags assigned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-book me-2"></i>Glossary Terms</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-glossary-list">
                                    <p class="text-muted">No glossary terms assigned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Structured Properties -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-list-alt me-2"></i>Structured Properties</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-structured-properties">
                                    <p class="text-muted">No structured properties assigned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Properties -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Properties</h6>
                            </div>
                            <div class="card-body">
                                <div id="modal-product-properties">
                                    <p class="text-muted">No additional properties</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Raw JSON Data -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="fas fa-code me-2"></i>Raw Data</h6>
                            </div>
                            <div class="card-body">
                                <pre id="modal-raw-json" class="language-json"><code>Loading...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Data Products Enhanced JavaScript -->
<script src="{% static 'metadata_manager/data_products/data_products_enhanced.js' %}"></script>

<!-- Data Products inline functionality -->
<script>
// Legacy global variables (avoiding conflicts with external JS)
var legacyCurrentTab = 'synced';
var legacyCurrentFilters = {
    overview: null,  // single select for overview (total, synced, local, remote)
    content: []      // multi-select for content filters (has-entities, has-owners, has-domain, has-external-url)
};

// Global pagination state (legacy)
var legacyCurrentPagination = {
    synced: { page: 1, perPage: 25 },
    local: { page: 1, perPage: 25 },
    remote: { page: 1, perPage: 25 }
};

var legacyCurrentOverviewFilter = null;
var legacyCurrentSearch = {
    'synced': '',
    'local': '',
    'remote': ''
};
var selectedProducts = new Set();

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    loadProductsData();
                    loadDomainsForLookup(); // Load domains for name lookups
        loadGlossaryTermsForLookup(); // Load glossary terms for name lookups
        initializeFilterHandlers();
        initializeBulkSelection();
        updateBulkActionsBar(); // Ensure bulk actions are hidden initially
    initializeOverviewNavigation();
    setupStatisticsCardClickHandlers();
    
    // Search functionality for each tab
    ['synced', 'local', 'remote'].forEach(tab => {
        const searchInput = document.getElementById(`${tab}-search`);
        const clearButton = document.getElementById(`${tab}-clear`);
        
        if (searchInput) {
        searchInput.addEventListener('input', function() {
                // Reset pagination when searching
                legacyCurrentPagination[tab].page = 1;
            legacyCurrentSearch[tab] = this.value.toLowerCase();
            displayTabContent(tab);
        });
        }
        
        if (clearButton) {
        clearButton.addEventListener('click', function() {
                // Reset pagination when clearing search
                legacyCurrentPagination[tab].page = 1;
            searchInput.value = '';
            legacyCurrentSearch[tab] = '';
            displayTabContent(tab);
        });
        }
    });
    
    // Refresh button
    document.getElementById('refreshProducts').addEventListener('click', function() {
        loadProductsData();
    });
});

function setupStatisticsCardClickHandlers() {
    // Use event delegation for statistics cards
    document.addEventListener('click', function(e) {
        const stat = e.target.closest('.clickable-stat[data-filter]');
        if (!stat) return;
        
        const filter = stat.getAttribute('data-filter');
        applyStatisticFilter(filter);
    });
}

function applyStatisticFilter(filter) {
    console.log('applyStatisticFilter called with filter:', filter);
    
    const clickedCard = document.querySelector(`[data-filter="${filter}"]`);
    if (!clickedCard) {
        console.error('Could not find card with filter:', filter);
        return;
    }

    const category = clickedCard.getAttribute('data-category');
    
    // Reset pagination to page 1 when filters change
    resetPaginationToFirstPage();
    
    if (category === 'overview') {
        // Single select for overview - clear others and switch tabs if needed
        document.querySelectorAll('.clickable-stat[data-category="overview"]').forEach(card => {
            card.classList.remove('active');
        });
        
        if (filter !== 'total') {
            clickedCard.classList.add('active');
            legacyCurrentFilters.overview = filter;
        } else {
            legacyCurrentFilters.overview = null;
        }
        
        // Clear all other filters when switching overview
        legacyCurrentFilters.content = [];
        document.querySelectorAll('.multi-select.active').forEach(card => {
            card.classList.remove('active');
        });
        
        // Handle tab switching for overview filters
        switch(filter) {
            case 'total':
                console.log('Clearing all filters');
                clearAllFilters();
                break;
            case 'synced':
                console.log('Switching to synced tab');
                switchToTab('synced');
                break;
            case 'local':
                console.log('Switching to local tab');  
                switchToTab('local');
                break;
            case 'remote':
                console.log('Switching to remote tab');
                switchToTab('remote');
                break;
        }
    } else if (category === 'content') {
        // Multi-select for content filters
        const isActive = clickedCard.classList.contains('active');
        
        if (isActive) {
            // Remove from active filters
            clickedCard.classList.remove('active');
            const index = legacyCurrentFilters.content.indexOf(filter);
            if (index > -1) {
                legacyCurrentFilters.content.splice(index, 1);
            }
        } else {
            // Add to active filters
            clickedCard.classList.add('active');
            if (!legacyCurrentFilters.content.includes(filter)) {
                legacyCurrentFilters.content.push(filter);
            }
        }
        
        console.log('Updated filters:', legacyCurrentFilters);
        
        // Apply filters to all currently visible tabs
        ['synced', 'local', 'remote'].forEach(tabType => {
            displayTabContent(tabType);
        });
    }
}

function clearAllFilters() {
    console.log('Clearing all filters');
    
    // Clear all filter arrays
    legacyCurrentFilters = {
        overview: null,
        content: []
    };
    
    // Remove active class from all statistic cards
    document.querySelectorAll('.clickable-stat').forEach(card => {
        card.classList.remove('active');
    });
    
    // Redisplay all tabs
    ['synced', 'local', 'remote'].forEach(tabType => {
        displayTabContent(tabType);
    });
}

function switchToTab(tabName) {
    // Activate the correct tab
    const tabButton = document.getElementById(`${tabName}-tab`);
    if (tabButton) {
        tabButton.click();
    }
}

function matchesContentFilter(item) {
    // If no content filters are active, show all items
    const hasActiveFilters = legacyCurrentFilters.content.length > 0;
    
    if (!hasActiveFilters) {
        return true;
    }
    
    // Check each content filter
    for (const filter of legacyCurrentFilters.content) {
        switch (filter) {
            case 'has-entities':
                const entitiesCount = item.entities_count || (item.entity_urns && item.entity_urns.length) || 0;
                if (entitiesCount === 0) return false;
                break;
            case 'has-owners':
                const ownersCount = item.owners_count || (item.ownership && item.ownership.owners && item.ownership.owners.length) || 0;
                if (ownersCount === 0) return false;
                break;
            case 'has-domain':
                const hasDomain = item.domain_urn || (item.domain && item.domain.domain && item.domain.domain.urn);
                if (!hasDomain) return false;
                break;
            case 'has-external-url':
                const hasExternalUrl = item.external_url || (item.properties && item.properties.externalUrl);
                if (!hasExternalUrl) return false;
                break;
        }
    }
    
    return true;
}

function initializeOverviewNavigation() {
    // Overview navigation is now handled by setupStatisticsCardClickHandlers
    console.log('Overview navigation handled by statistics card click handlers');
}

function showTab(tabName) {
    // Activate the correct tab
    const tabButton = document.getElementById(`${tabName}-tab`);
    if (tabButton) {
        tabButton.click();
    }
}

function initializeBulkSelection() {
    // Handle select all checkboxes in headers
    document.querySelectorAll('.select-all-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const tabType = this.id.replace('selectAll', '').toLowerCase();
            const tableCheckbox = document.querySelector(`.select-all-table[data-tab="${tabType}"]`);
            if (tableCheckbox) {
                tableCheckbox.checked = this.checked;
                handleSelectAllTable(tableCheckbox);
            }
        });
    });
    
    // Handle individual checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-checkbox')) {
            handleIndividualCheckbox(e.target);
        } else if (e.target.classList.contains('select-all-table')) {
            handleSelectAllTable(e.target);
        }
    });
    
    // Handle bulk action buttons
    document.getElementById('bulkSync')?.addEventListener('click', handleBulkSync);
    document.getElementById('bulkAddToPR')?.addEventListener('click', handleBulkAddToPR);
    document.getElementById('bulkDelete')?.addEventListener('click', handleBulkDelete);
    document.getElementById('bulkDownload')?.addEventListener('click', handleBulkDownload);
}

function handleSelectAllTable(selectAllCheckbox) {
    const tabType = selectAllCheckbox.dataset.tab;
    const checkboxes = document.querySelectorAll(`.product-checkbox[data-tab="${tabType}"]`);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const row = checkbox.closest('tr');
        const productId = row.dataset.productId || row.dataset.productUrn;
        
        if (selectAllCheckbox.checked) {
            selectedProducts.add(productId);
        } else {
            selectedProducts.delete(productId);
        }
    });
    
    updateBulkActionsBar();
    updateHeaderCheckboxes();
}

function handleIndividualCheckbox(checkbox) {
    const row = checkbox.closest('tr');
    const productId = row.dataset.productId || row.dataset.productUrn;
    
    if (checkbox.checked) {
        selectedProducts.add(productId);
    } else {
        selectedProducts.delete(productId);
    }
    
    updateBulkActionsBar();
    updateHeaderCheckboxes();
    updateTableSelectAll(checkbox.dataset.tab);
}

function updateTableSelectAll(tabType) {
    const tableCheckbox = document.querySelector(`.select-all-table[data-tab="${tabType}"]`);
    const individualCheckboxes = document.querySelectorAll(`.product-checkbox[data-tab="${tabType}"]`);
    const checkedCheckboxes = document.querySelectorAll(`.product-checkbox[data-tab="${tabType}"]:checked`);
    
    if (tableCheckbox) {
        if (checkedCheckboxes.length === 0) {
            tableCheckbox.checked = false;
            tableCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === individualCheckboxes.length) {
            tableCheckbox.checked = true;
            tableCheckbox.indeterminate = false;
        } else {
            tableCheckbox.checked = false;
            tableCheckbox.indeterminate = true;
        }
    }
}

function updateHeaderCheckboxes() {
    // Update header checkboxes to match table state
    ['synced', 'local', 'remote'].forEach(tabType => {
        const headerCheckbox = document.getElementById(`selectAll${tabType.charAt(0).toUpperCase() + tabType.slice(1)}`);
        const tableCheckbox = document.querySelector(`.select-all-table[data-tab="${tabType}"]`);
        
        if (headerCheckbox && tableCheckbox) {
            headerCheckbox.checked = tableCheckbox.checked;
            headerCheckbox.indeterminate = tableCheckbox.indeterminate;
        }
    });
}

function updateBulkActionsBar() {
    // Update all bulk action bars for each tab
    ['synced', 'local', 'remote'].forEach(tabType => {
        const bulkActionsBar = document.getElementById(`${tabType}-bulk-actions`);
        const selectedCountElement = document.getElementById(`${tabType}-selected-count`);
        
        if (bulkActionsBar && selectedCountElement) {
            const selectedCount = getSelectedProductsForTab(tabType).length;
            selectedCountElement.textContent = selectedCount;
            
            if (selectedCount > 0) {
                bulkActionsBar.classList.add('show');
            } else {
                bulkActionsBar.classList.remove('show');
            }
        }
    });
}

function getSelectedProductsForTab(tabType) {
    const checkboxes = document.querySelectorAll(`input[data-tab="${tabType}"].product-checkbox:checked`);
    return Array.from(checkboxes);
}

// Bulk sync to local function - implemented directly in template to ensure it works
async function bulkSyncToLocal(tabType) {
    const selectedCheckboxes = getSelectedProductsForTab(tabType);
    if (selectedCheckboxes.length === 0) {
        showError('No products selected');
        return;
    }
    
    if (!confirm(`Are you sure you want to sync ${selectedCheckboxes.length} product(s) to local?`)) {
        return;
    }
    
    showSuccess(`Starting sync of ${selectedCheckboxes.length} product(s) to local...`);
    
    let successCount = 0;
    let errorCount = 0;
    
    // Process products sequentially to avoid overwhelming the server
    for (const checkbox of selectedCheckboxes) {
        try {
            const row = checkbox.closest('tr');
            const productUrn = row.dataset.productUrn;
            
            if (!productUrn) {
                console.error('No product URN found for row:', row);
                errorCount++;
                continue;
            }
            
            await syncSingleProductToLocal(productUrn);
            successCount++;
        } catch (error) {
            console.error(`Error syncing product:`, error);
            errorCount++;
        }
    }
    
    // Reload data once at the end
    await loadProductsData();
    
    if (errorCount === 0) {
        showSuccess(`Successfully synced ${successCount} product(s) to local`);
    } else {
        showError(`Completed: ${successCount} synced successfully, ${errorCount} failed`);
    }
}

async function syncSingleProductToLocal(productUrn) {
    const response = await fetch('/metadata/data-products/sync-to-local/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            'product_urn': productUrn
        })
    });
    
    const data = await response.json();
    
    if (!data.success) {
        throw new Error(data.error || 'Unknown error');
    }
    
    return data;
}

function handleBulkSync() {
    if (selectedProducts.size === 0) return;
    
    const confirmMessage = `Are you sure you want to sync ${selectedProducts.size} selected data product(s)?`;
    if (!confirm(confirmMessage)) return;
    
    // Implementation for bulk sync
    console.log('Bulk sync:', Array.from(selectedProducts));
    showSuccess(`Syncing ${selectedProducts.size} data products...`);
}

// Bulk add to PR function
async function bulkAddToPR(tabType) {
    const selectedCheckboxes = getSelectedProductsForTab(tabType);
    if (selectedCheckboxes.length === 0) {
        showError('No products selected');
        return;
    }
    
    if (!confirm(`Are you sure you want to add ${selectedCheckboxes.length} product(s) to staged changes?`)) {
        return;
    }
    
    showSuccess(`Starting to add ${selectedCheckboxes.length} product(s) to staged changes...`);
    
    let successCount = 0;
    let errorCount = 0;
    
    // Process products sequentially
    for (const checkbox of selectedCheckboxes) {
        try {
            const row = checkbox.closest('tr');
            const productId = row.dataset.productId;
            
            if (!productId) {
                console.error('No product ID found for row:', row);
                errorCount++;
                continue;
            }
            
            await addSingleProductToPR(productId);
            successCount++;
        } catch (error) {
            console.error(`Error adding product to PR:`, error);
            errorCount++;
        }
    }
    
    if (errorCount === 0) {
        showSuccess(`Successfully added ${successCount} product(s) to staged changes`);
    } else {
        showError(`Completed: ${successCount} added successfully, ${errorCount} failed`);
    }
}

async function addSingleProductToPR(productId) {
    const response = await fetch(`/metadata/data-products/${productId}/stage_changes/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    });
    
    const data = await response.json();
    
    if (!data.success) {
        throw new Error(data.error || 'Unknown error');
    }
    
    return data;
}

function handleBulkAddToPR() {
    if (selectedProducts.size === 0) return;
    
    const confirmMessage = `Are you sure you want to add ${selectedProducts.size} selected data product(s) to PR?`;
    if (!confirm(confirmMessage)) return;
    
    // Implementation for bulk add to PR
    console.log('Bulk add to PR:', Array.from(selectedProducts));
    showSuccess(`Adding ${selectedProducts.size} data products to PR...`);
}

function handleBulkDelete() {
    if (selectedProducts.size === 0) return;
    
    const confirmMessage = `Are you sure you want to delete ${selectedProducts.size} selected data product(s)? This action cannot be undone.`;
    if (!confirm(confirmMessage)) return;
    
    // Implementation for bulk delete
    console.log('Bulk delete:', Array.from(selectedProducts));
    showSuccess(`Deleting ${selectedProducts.size} data products...`);
}

// Bulk download function
function bulkDownloadJson(tabType) {
    const selectedCheckboxes = getSelectedProductsForTab(tabType);
    if (selectedCheckboxes.length === 0) {
        showError('No products selected');
        return;
    }
    
    const selectedProducts = [];
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const productId = row.dataset.productId;
        const productUrn = row.dataset.productUrn;
        const storeKey = productId || productUrn;
        
        // Try to find the product data in the global data store
        let productData = null;
        if (window.productDataStore && window.productDataStore[tabType]) {
            productData = window.productDataStore[tabType].get(storeKey);
        }
        
        if (productData) {
            selectedProducts.push(productData);
        } else {
            // Fallback: create minimal product object from row data
            const nameCell = row.querySelector('td:nth-child(2)');
            const name = nameCell ? nameCell.textContent.trim() : 'Unknown';
            
            selectedProducts.push({
                id: productId,
                urn: productUrn,
                name: name
            });
        }
    });
    
    const jsonData = JSON.stringify(selectedProducts, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `data-products-bulk-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    
    setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }, 100);
    
    showSuccess(`Downloaded ${selectedProducts.length} data products as JSON`);
}

function handleBulkDownload() {
    if (selectedProducts.size === 0) return;
    
    // Implementation for bulk download
    console.log('Bulk download:', Array.from(selectedProducts));
    showSuccess(`Downloading ${selectedProducts.size} data products...`);
}

// Global bulk action functions
function resyncAllProducts() {
    if (!confirm('Are you sure you want to resync all data products? This may take some time.')) return;
    
    // Implementation for resync all
    console.log('Resync all products');
    showSuccess('Resyncing all data products...');
}

function exportAllProducts() {
    // Implementation for export all
    console.log('Export all products');
    showSuccess('Exporting all data products...');
}

function addAllProductsToStagedChanges() {
    if (!confirm('Are you sure you want to add all data products to staged changes?')) return;
    
    // Implementation for add all to staged changes
    console.log('Add all products to staged changes');
    showSuccess('Adding all data products to staged changes...');
}

function showImportProductsModal() {
    // Implementation for import modal
    console.log('Show import products modal');
    // You would show a modal here for importing JSON
}

function loadProductsData() {
    console.log('Loading products data...');
    showLoading(true);
    
    fetch('/metadata/data-products/data/')
        .then(response => {
            console.log('Received response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Parsed data:', data.success);
            if (data.success) {
                console.log('Statistics:', data.data.statistics);
                console.log('Synced items:', data.data.synced_items?.length || 0);
                console.log('Local only items:', data.data.local_only_items?.length || 0);
                console.log('Remote only items:', data.data.remote_only_items?.length || 0);
                
                productsData = data.data;
                updateStatistics(data.data.statistics);
                updateTabBadges();
                displayAllTabs();
            } else {
                console.error('Data loading failed:', data.error);
                showError('Failed to load products: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading products:', error);
            showError('Failed to load products data: ' + error.message);
        })
        .finally(() => {
            showLoading(false);
        });
}

function showLoading(show) {
    document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
    document.getElementById('products-content').style.display = show ? 'none' : 'block';
}

function updateStatistics(stats) {
    document.getElementById('total-items').textContent = stats.total_items || 0;
    document.getElementById('synced-count').textContent = stats.synced_count || 0;
    document.getElementById('local-count').textContent = stats.local_only_count || 0;
    document.getElementById('remote-count').textContent = stats.remote_only_count || 0;
    updateEnhancedStatistics();
}

function updateTabBadges() {
    document.getElementById('synced-badge').textContent = (productsData.synced_items || []).length;
    document.getElementById('local-badge').textContent = (productsData.local_only_items || []).length;
    document.getElementById('remote-badge').textContent = (productsData.remote_only_items || []).length;
}

function updateEnhancedStatistics() {
    if (!productsData) return;
    
    // Get all products from all categories
    const allProducts = [
        ...(productsData.synced_items || []).map(item => item.combined || item),
        ...(productsData.local_only_items || []),
        ...(productsData.remote_only_items || [])
    ].filter(Boolean); // Remove any null/undefined items
    
    // Calculate content statistics
    const withEntities = allProducts.filter(p => {
        const entitiesCount = p.entities_count || p.entities?.total || (p.entity_urns && p.entity_urns.length) || 0;
        return entitiesCount > 0;
    }).length;
    
    const withOwners = allProducts.filter(p => {
        const ownersCount = p.owners_count || (p.ownership && p.ownership.owners && p.ownership.owners.length) || 0;
        return ownersCount > 0;
    }).length;
    
    const withDomain = allProducts.filter(p => {
        return p.domain_urn || (p.domain && p.domain.domain && p.domain.domain.urn) || false;
    }).length;
    
    const withExternalUrl = allProducts.filter(p => {
        return p.external_url || (p.properties && p.properties.externalUrl) || false;
    }).length;
    
    // Update content statistics (with null safety)
    const entitiesElement = document.getElementById('products-with-entities');
    const ownersElement = document.getElementById('products-with-owners');
    const domainElement = document.getElementById('products-with-domain');
    const urlElement = document.getElementById('products-with-external-url');
    
    if (entitiesElement) entitiesElement.textContent = withEntities;
    if (ownersElement) ownersElement.textContent = withOwners;
    if (domainElement) domainElement.textContent = withDomain;
    if (urlElement) urlElement.textContent = withExternalUrl;
}

function displayAllTabs() {
    displayTabContent('synced');
    displayTabContent('local');
    displayTabContent('remote');
}

function displayTabContent(tabType) {
    console.log('Displaying tab content for:', tabType);
    
    // Clear the data store for this tab type before rendering new data
    productDataStore[tabType].clear();
    
    let items, contentId;
    
    try {
        switch(tabType) {
            case 'synced':
                items = (productsData.synced_items || []).map(item => item.combined || item);
                contentId = 'synced-content';
                break;
            case 'local':
                items = productsData.local_only_items || [];
                contentId = 'local-content';
                break;
            case 'remote':
                items = productsData.remote_only_items || [];
                contentId = 'remote-content';
                break;
        }
        
        console.log(`Tab ${tabType}: ${items?.length || 0} items`);
        
        // Sort items alphabetically by name (A-Z)
        if (items && items.length > 0) {
            items.sort((a, b) => {
                const nameA = (a.properties?.name || a.name || '').toLowerCase();
                const nameB = (b.properties?.name || b.name || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });
        }
        
        console.log(`Starting with ${items?.length || 0} items for tab ${tabType}`);
        
        // Apply content filters first
        const hasActiveContentFilters = legacyCurrentFilters.content && legacyCurrentFilters.content.length > 0;
        
        if (hasActiveContentFilters) {
            console.log('🔍 Applying content filters:', legacyCurrentFilters.content);
            console.log('🔍 Items before filter:', items.length);
            const beforeFilter = items.length;
            items = items.filter(item => {
                const result = matchesContentFilter(item);
                console.log('🔍 Testing item:', item.properties?.name || item.name, 'Result:', result);
                return result;
            });
            console.log(`🔍 Content filter applied: ${beforeFilter} -> ${items.length} items`);
        } else {
            console.log('🔍 No content filters applied. Current filters:', legacyCurrentFilters);
        }
        
        // Then apply search filter on the filtered results
        const searchTerm = legacyCurrentSearch[tabType];
        if (searchTerm) {
            console.log('Applying search filter:', searchTerm);
            const beforeSearch = items.length;
            items = items.filter(item => 
                (item.properties?.name || item.name || '').toLowerCase().includes(searchTerm) ||
                (item.properties?.description || item.description || '').toLowerCase().includes(searchTerm) ||
                (item.domain?.domain?.properties?.name || '').toLowerCase().includes(searchTerm) ||
                (item.urn || '').toLowerCase().includes(searchTerm)
            );
            console.log(`Search filter applied: ${beforeSearch} -> ${items.length} items`);
        }
        
        console.log(`Final filtered results: ${items.length} items`);
        
        const content = document.getElementById(contentId);
        if (!content) {
            console.error('Content element not found:', contentId);
            return;
        }
        
        if (items.length === 0) {
            console.log(`No items for ${tabType}, showing empty state`);
            content.innerHTML = getEmptyStateHTML(tabType, searchTerm);
            return;
        }
        
        console.log(`Generating table for ${tabType} with ${items.length} items`);
        const tableHTML = generateTableHTML(items, tabType);
        content.innerHTML = tableHTML;
        
        // Attach click handlers for view buttons
        const viewButtons = content.querySelectorAll('.view-item');
        console.log('Found view-item buttons:', viewButtons.length);
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('View button clicked');
                const row = this.closest('tr');
                const productId = row.dataset.productId;
                const productUrn = row.dataset.productUrn;
                const storeKey = productId || productUrn;
                
                // Find the product data in the appropriate store
                let itemData = null;
                for (const [tabType, store] of Object.entries(productDataStore)) {
                    if (store.has(storeKey)) {
                        itemData = store.get(storeKey);
                        break;
                    }
                }
                
                if (itemData) {
                    console.log('Showing product details for:', itemData);
                    showProductDetails(itemData);
                } else {
                    console.error('Product data not found in store for key:', storeKey);
                    showError('Unable to load product details');
                }
            });
        });
        
        // Attach action button handlers
        attachActionButtonHandlers(content);
        
        // Attach pagination handlers
        attachPaginationHandlers(content, tabType);
        
        console.log(`Successfully rendered ${tabType} tab`);
        
    } catch (error) {
        console.error(`Error displaying ${tabType} tab:`, error);
        const content = document.getElementById(contentId);
        if (content) {
            content.innerHTML = `<div class="alert alert-danger">Error loading ${tabType} products: ${error.message}</div>`;
        }
    }
}

// Helper function to reset pagination to page 1 for all tabs
function resetPaginationToFirstPage() {
    legacyCurrentPagination.synced.page = 1;
    legacyCurrentPagination.local.page = 1;
    legacyCurrentPagination.remote.page = 1;
}

function getEmptyStateHTML(tabType, hasSearch) {
    if (hasSearch) {
        return `
            <div class="py-5 text-center">
                <div class="mb-3">
                    <i class="fas fa-search fa-4x text-muted"></i>
                </div>
                <h4>No products found</h4>
                <p class="text-muted">No products match your search criteria.</p>
            </div>
        `;
    }
    
    const emptyStates = {
        synced: {
            icon: 'fas fa-sync-alt',
            title: 'No synced products',
            description: 'Products that exist both locally and in DataHub will appear here.'
        },
        local: {
            icon: 'fas fa-laptop',
            title: 'No local-only products',
            description: 'Products that exist only in this application will appear here.',
            action: `<div class="mt-2">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDataProductModal">
                            <i class="fas fa-plus me-1"></i> Create Data Product
                        </button>
                     </div>`
        },
        remote: {
            icon: 'fas fa-server',
            title: 'No remote-only products',
            description: 'Products that exist only in DataHub will appear here.'
        }
    };
    
    const state = emptyStates[tabType];
    return `
        <div class="py-5 text-center">
            <div class="mb-3">
                <i class="${state.icon} fa-4x text-muted"></i>
            </div>
            <h4>${state.title}</h4>
            <p class="text-muted">${state.description}</p>
            ${state.action || ''}
        </div>
    `;
}

function showProductDetails(product) {
    // Basic information
    const name = product.properties?.name || product.name || 'Unnamed';
    const description = product.properties?.description || product.description || 'No description available';
    const externalUrl = product.properties?.externalUrl || product.external_url || '';
    const urn = product.urn || 'No URN available';
    
    // Safely update modal elements with null checks
    const nameElement = document.getElementById('modal-product-name');
    const descriptionElement = document.getElementById('modal-product-description');
    const urnElement = document.getElementById('modal-product-urn');
    const externalUrlElement = document.getElementById('modal-product-external-url');
    
    if (nameElement) nameElement.textContent = name;
    if (descriptionElement) descriptionElement.textContent = description;
    if (urnElement) urnElement.textContent = urn;
    
    // External URL
    if (externalUrlElement) {
        if (externalUrl) {
            externalUrlElement.innerHTML = `<a href="${escapeHtml(externalUrl)}" target="_blank" class="text-decoration-none">${escapeHtml(externalUrl)}</a>`;
        } else {
            externalUrlElement.textContent = 'No external URL';
        }
    }
    
    // Domain
    const domainElement = document.getElementById('modal-product-domain');
    if (domainElement) {
            // Extract domain information using the same logic as the table  
    const domainUrn = product.domain?.domain?.urn || product.domain_urn || '';
    let domainName = product.domain?.domain?.properties?.name || '';
    
    // If no domain name but we have a URN, try to get it from domains cache
    if (!domainName && domainUrn) {
        domainName = getDomainName(domainUrn);

    }
        
        // Fallback to URN extraction if still no name
        if (!domainName && domainUrn) {
            const parts = domainUrn.split(':');
            domainName = parts[parts.length - 1] || domainUrn;
        }
        
        if (domainName) {
            domainElement.innerHTML = `<span class="badge bg-info">${escapeHtml(domainName)}</span>`;
        } else {
            domainElement.textContent = 'No domain assigned';
        }
    }
    
    // Status
    const statusBadge = document.getElementById('modal-product-status');
    if (statusBadge) {
        statusBadge.textContent = product.sync_status_display || product.sync_status;
        statusBadge.className = `badge ${getStatusBadgeClass(product.sync_status)}`;
    }
    
    // Entities information
    const entitiesList = document.getElementById('modal-entities-list');
    const entityCount = product.entities_count || product.entities?.total || (product.entity_urns ? product.entity_urns.length : 0) || 0;
    
    if (entitiesList) {
        if (entityCount > 0 && product.entity_urns && product.entity_urns.length > 0) {
            entitiesList.innerHTML = product.entity_urns.map(entityUrn => `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                            <strong>Entity</strong>
                            <span class="badge bg-primary ms-2">Asset</span>
                            </div>
                        </div>
                        <div class="mt-1">
                        <code class="small">${escapeHtml(entityUrn)}</code>
                        </div>
                            </div>
            `).join('');
        } else {
            entitiesList.innerHTML = '<p class="text-muted">No entities assigned</p>';
        }
    }
    
    // Ownership information
    const ownersList = document.getElementById('modal-owners-list');
    const owners = product.ownership?.owners || [];
    
    if (ownersList) {
        if (owners.length > 0) {
            ownersList.innerHTML = owners.map(owner => {
                const ownerInfo = owner.owner;
                const displayName = ownerInfo?.properties?.displayName || ownerInfo?.info?.displayName || ownerInfo?.username || ownerInfo?.name || 'Unknown Owner';
                const ownerType = owner.type || 'OWNERSHIP';
                const ownerUrn = ownerInfo?.urn || 'No URN';
                
                return `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                                <strong>${escapeHtml(displayName)}</strong>
                                <span class="badge bg-info ms-2">${ownerType}</span>
                        </div>
                    </div>
                    <div class="mt-1">
                            <code class="small">${escapeHtml(ownerUrn)}</code>
                    </div>
                </div>
                `;
            }).join('');
        } else {
            ownersList.innerHTML = '<p class="text-muted">No owners assigned</p>';
        }
    }
    
    // Tags information
    const tagsList = document.getElementById('modal-tags-list');
    const tags = product.tags?.tags || product.globalTags?.tags || [];
    
    if (tagsList) {
        if (tags.length > 0) {
            tagsList.innerHTML = tags.map(tag => {
                const tagUrn = tag.tag?.urn || tag.urn || '';
                // Extract tag name from URN - handle both regular tags and glossary term tags
                let tagName = tag.tag?.properties?.name || tag.name;
                
                if (!tagName && tagUrn) {
                    if (tagUrn.includes('glossaryTerm:')) {
                        // Extract glossary term name from URN like "urn:li:tag:urn:li:glossaryTerm:ClientsAndAccounts.AccountBalance"
                        const parts = tagUrn.split(':');
                        tagName = parts[parts.length - 1] || tagUrn;
                    } else {
                        // Extract regular tag name from URN like "urn:li:tag:identity"
                        const parts = tagUrn.split(':');
                        tagName = parts[parts.length - 1] || tagUrn;
                    }
                }
                
                tagName = tagName || 'Unknown Tag';
                
                return `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${escapeHtml(tagName)}</strong>
                            <span class="badge bg-secondary ms-2">Tag</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <code class="small">${escapeHtml(tagUrn)}</code>
                    </div>
                </div>
                `;
            }).join('');
        } else {
            tagsList.innerHTML = '<p class="text-muted">No tags assigned</p>';
        }
    }
    
    // Glossary terms information
    const glossaryList = document.getElementById('modal-glossary-list');
    const glossaryTerms = product.glossaryTerms?.terms || product.terms || [];
    
    if (glossaryList) {
        if (glossaryTerms.length > 0) {
            glossaryList.innerHTML = glossaryTerms.map(term => {
                const termUrn = term.term?.urn || term.urn || '';
                let termName = term.term?.properties?.name || term.name || '';
                
                // Try to get name from cache if not available
                if (!termName && termUrn) {
                    termName = getGlossaryTermName(termUrn);
                }
                
                // Fallback to URN extraction if still no name
                if (!termName && termUrn) {
                    const parts = termUrn.split(':');
                    termName = parts[parts.length - 1] || termUrn;
                }
                
                termName = termName || 'Unknown Term';
                
                return `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${escapeHtml(termName)}</strong>
                            <span class="badge bg-info ms-2">Glossary Term</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        <code class="small">${escapeHtml(termUrn)}</code>
                    </div>
                </div>
                `;
            }).join('');
        } else {
            glossaryList.innerHTML = '<p class="text-muted">No glossary terms assigned</p>';
        }
    }
    
    // Properties information - handle both custom and structured properties like glossary
    const structuredPropertiesDiv = document.getElementById('modal-structured-properties');
    let propertiesHTML = '';
    
    // Custom Properties - get from customProperties array in the data
    let customProperties = [];
    if (product.customProperties && Array.isArray(product.customProperties)) {
        customProperties = product.customProperties;
    }
    
    // Structured Properties - get from structuredProperties.properties array
    let structuredProperties = [];
    if (product.structuredProperties && product.structuredProperties.properties && Array.isArray(product.structuredProperties.properties)) {
        structuredProperties = product.structuredProperties.properties;
    }
    
    // Custom Properties Section
    if (customProperties && customProperties.length > 0) {
        propertiesHTML += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-tags me-2"></i>Custom Properties (${customProperties.length})</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${customProperties.map(prop => `
                            <div class="col-md-6 mb-2">
                                <dl class="row mb-0">
                                    <dt class="col-sm-5 text-truncate" title="${escapeHtml(prop.key || 'Unknown')}">${escapeHtml(prop.key || 'Unknown')}:</dt>
                                    <dd class="col-sm-7 mb-0">
                                        <span class="text-break">${escapeHtml(prop.value || '')}</span>
                                    </dd>
                                </dl>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Structured Properties Section
    if (structuredProperties && structuredProperties.length > 0) {
        propertiesHTML += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>Structured Properties (${structuredProperties.length})</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${structuredProperties.map(prop => {
                            // Extract property information from the structured property format
                            const structuredProperty = prop.structuredProperty;
                            const propertyUrn = structuredProperty?.urn || 'Unknown';
                            const displayName = structuredProperty?.definition?.displayName || 
                                              structuredProperty?.definition?.qualifiedName ||
                                              propertyUrn.split(':').pop() || 
                                              propertyUrn;
                            
                            // Extract values from the values array
                            let propertyValue = '';
                            if (prop.values && Array.isArray(prop.values)) {
                                propertyValue = prop.values.map(valueObj => {
                                    // Handle different value types (stringValue, doubleValue, etc.)
                                    if (valueObj.stringValue !== undefined) return valueObj.stringValue;
                                    if (valueObj.doubleValue !== undefined) return valueObj.doubleValue;
                                    if (valueObj.intValue !== undefined) return valueObj.intValue;
                                    if (valueObj.booleanValue !== undefined) return valueObj.booleanValue;
                                    if (valueObj.timestampValue !== undefined) return new Date(valueObj.timestampValue).toISOString();
                                    if (valueObj.urnValue !== undefined) return valueObj.urnValue;
                                    return JSON.stringify(valueObj);
                                }).filter(v => v !== null && v !== undefined).join(', ');
                            }
                            
                            return `
                                <div class="col-md-6 mb-2">
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-truncate" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}:</dt>
                                        <dd class="col-sm-7 mb-0">
                                            <span class="text-break">${escapeHtml(propertyValue || 'No value')}</span>
                                            <br><small class="text-muted" title="${escapeHtml(propertyUrn)}">URN: ${escapeHtml(propertyUrn)}</small>
                                        </dd>
                                    </dl>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    if (structuredPropertiesDiv) {
        if (propertiesHTML) {
            structuredPropertiesDiv.innerHTML = propertiesHTML;
        } else {
            // Show empty cards for both custom and structured properties
            structuredPropertiesDiv.innerHTML = `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0"><i class="fas fa-tags me-2"></i>Custom Properties (0)</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-tags fa-2x mb-2"></i><br>
                            No custom properties available
                        </div>
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>Structured Properties (0)</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-cogs fa-2x mb-2"></i><br>
                            No structured properties available
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // DataHub link
    const datahubLink = document.getElementById('modal-datahub-link');
    if (datahubLink) {
        if (product.urn && !product.urn.includes('local:') && productsData.datahub_url) {
            datahubLink.href = getDataHubUrl(product.urn, 'product');
            datahubLink.style.display = 'inline-block';
        } else {
            datahubLink.style.display = 'none';
        }
    }
    
    // Properties section is now handled above with custom and structured properties combined
    const propertiesDiv = document.getElementById('modal-product-properties');
    if (propertiesDiv) {
        // This section is now redundant since we handle both custom and structured properties above
        propertiesDiv.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                Properties are displayed in the sections above
            </div>
        `;
    }
    
    // Raw JSON
    const rawJsonElement = document.getElementById('modal-raw-json');
    if (rawJsonElement) {
        try {
            const rawData = product.raw_data || product;
            // Create a clean copy without circular references
            const cleanData = JSON.parse(JSON.stringify(rawData));
            const jsonString = JSON.stringify(cleanData, null, 2);
            rawJsonElement.innerHTML = `<code class="language-json">${escapeHtml(jsonString)}</code>`;
        } catch (error) {
            console.error('Error formatting raw JSON:', error);
            rawJsonElement.innerHTML = `<code class="language-json">${escapeHtml(JSON.stringify({error: 'Unable to display raw data', product_name: product.properties?.name || product.name}, null, 2))}</code>`;
        }
    }
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('viewDataProductModal'));
    modal.show();
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

function truncateUrn(urn, maxLength) {
    if (!urn || urn.length <= maxLength) return urn;
    return urn.substring(0, maxLength - 3) + '...';
}

function formatDate(timestamp) {
    try {
        const date = new Date(parseInt(timestamp));
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    } catch (e) {
        return timestamp;
    }
}

function getDataHubUrl(urn, type) {
    if (productsData.datahub_url) {
        return `${productsData.datahub_url}/dataProduct/${encodeURIComponent(urn)}`;
    }
    return '#';
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'SYNCED': return 'bg-success';
        case 'MODIFIED': return 'bg-warning';
        case 'LOCAL_ONLY': return 'bg-secondary';
        case 'REMOTE_ONLY': return 'bg-info';
        default: return 'bg-primary';
    }
}

function getCsrfToken() {
    const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfElement ? csrfElement.value : '';
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Find a safe place to insert the alert
    const container = document.querySelector('.container-fluid');
    const row = container ? container.querySelector('.row') : null;
    
    if (container && row && container.contains(row)) {
        container.insertBefore(alert, row);
    } else {
        // Fallback: append to body or a safe container
        const safeContainer = document.querySelector('main') || document.body;
        safeContainer.insertBefore(alert, safeContainer.firstChild);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Find a safe place to insert the alert
    const container = document.querySelector('.container-fluid');
    const row = container ? container.querySelector('.row') : null;
    
    if (container && row && container.contains(row)) {
        container.insertBefore(alert, row);
    } else {
        // Fallback: append to body or a safe container
        const safeContainer = document.querySelector('main') || document.body;
        safeContainer.insertBefore(alert, safeContainer.firstChild);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function initializeFilterHandlers() {
    // Initialize filter handling functionality
    console.log('Filter handlers initialized');
}

function generateTableHTML(items, tabType) {
    const pagination = legacyCurrentPagination[tabType];
    const totalItems = items.length;
    const totalPages = Math.ceil(totalItems / pagination.perPage);
    const startIndex = (pagination.page - 1) * pagination.perPage;
    const endIndex = startIndex + pagination.perPage;
    const paginatedItems = items.slice(startIndex, endIndex);
    
    const showingStart = totalItems === 0 ? 0 : startIndex + 1;
    const showingEnd = Math.min(endIndex, totalItems);
    
    return `
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th class="checkbox-column">
                            <input type="checkbox" class="form-check-input select-all-table" data-tab="${tabType}">
                        </th>
                        <th width="15%">Name</th>
                        <th width="20%">Description</th>
                        <th>Entities</th>
                                        <th>Domain</th>
                <th>Tags</th>
                <th>Glossary Terms</th>
                <th>Custom Properties</th>
                <th>Structured Properties</th>
                <th>Owners</th>
                        ${tabType === 'synced' ? '<th>Sync Status</th>' : ''}
                        <th>URN</th>
                        <th width="15%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedItems.map(item => renderProductRow(item, tabType)).join('')}
                </tbody>
            </table>
        </div>
        ${generatePaginationHTML(pagination.page, totalPages, totalItems, showingStart, showingEnd, tabType)}
    `;
}

function generatePaginationHTML(currentPage, totalPages, totalItems, showingStart, showingEnd, tabType) {
    if (totalPages <= 1) return '';
    
    let paginationHTML = `
        <div class="pagination-container d-flex justify-content-between align-items-center">
            <div class="pagination-info">
                Showing ${showingStart} to ${showingEnd} of ${totalItems} entries
            </div>
            <nav aria-label="Table pagination">
                <ul class="pagination mb-0">
    `;
    
    // Previous button
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" data-page="${currentPage - 1}" data-tab="${tabType}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="1" data-tab="${tabType}">1</a></li>`;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationHTML += `<li class="page-item ${activeClass}"><a class="page-link" href="#" data-page="${i}" data-tab="${tabType}">${i}</a></li>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}" data-tab="${tabType}">${totalPages}</a></li>`;
    }
    
    // Next button
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" data-page="${currentPage + 1}" data-tab="${tabType}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    paginationHTML += `
                </ul>
            </nav>
            <div class="d-flex align-items-center">
                <label for="perPage-${tabType}" class="form-label me-2 mb-0 small">Per page:</label>
                <select id="perPage-${tabType}" class="form-select form-select-sm" style="width: auto;">
                                                <option value="10" ${legacyCurrentPagination[tabType].perPage === 10 ? 'selected' : ''}>10</option>
                            <option value="25" ${legacyCurrentPagination[tabType].perPage === 25 ? 'selected' : ''}>25</option>
                            <option value="50" ${legacyCurrentPagination[tabType].perPage === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${legacyCurrentPagination[tabType].perPage === 100 ? 'selected' : ''}>100</option>
                </select>
            </div>
        </div>
    `;
    
    return paginationHTML;
}

function attachPaginationHandlers(content, tabType) {
    // Handle page link clicks
    content.querySelectorAll('.page-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = parseInt(this.dataset.page);
            if (page && !this.closest('.page-item').classList.contains('disabled')) {
                legacyCurrentPagination[tabType].page = page;
                displayTabContent(tabType);
            }
        });
    });
    
    // Handle per-page change
    const perPageSelect = content.querySelector(`#perPage-${tabType}`);
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            legacyCurrentPagination[tabType].perPage = parseInt(this.value);
            legacyCurrentPagination[tabType].page = 1; // Reset to first page
            displayTabContent(tabType);
        });
    }
}

// Universal function to sanitize data for HTML attributes to prevent URI length issues
function sanitizeDataForAttribute(item, maxDescriptionLength = 500) {
    if (!item || typeof item !== 'object') {
        return item;
    }
    
    const sanitized = { ...item };
    
    // Truncate description if it's too long
    if (sanitized.description && typeof sanitized.description === 'string' && sanitized.description.length > maxDescriptionLength) {
        sanitized.description = sanitized.description.substring(0, maxDescriptionLength) + '...[truncated]';
    }
    
    // Truncate properties.description if it exists
    if (sanitized.properties && sanitized.properties.description && 
        typeof sanitized.properties.description === 'string' && 
        sanitized.properties.description.length > maxDescriptionLength) {
        sanitized.properties = {
            ...sanitized.properties,
            description: sanitized.properties.description.substring(0, maxDescriptionLength) + '...[truncated]'
        };
    }
    
    // Remove potentially large raw data objects
    sanitized.raw_data = undefined;
    
    return sanitized;
}

function renderProductRow(product, tabType) {
    const statusClass = getStatusBadgeClass(product.sync_status);
    const typeIcon = 'fas fa-cube text-primary';
    
    // Extract product data
    const name = product.properties?.name || product.name || 'Unnamed';
    const description = product.properties?.description || product.description || '';
    const entityCount = product.entities_count || product.entities?.total || (product.entity_urns ? product.entity_urns.length : 0) || 0;
    const urn = product.urn || '';
    const productId = product.id || urn;
    
    // Extract domain information
    const domainUrn = product.domain?.domain?.urn || product.domain_urn || '';
    let domainName = product.domain?.domain?.properties?.name || '';
    
    // Debug domain lookup
    if (domainUrn && !domainName) {
        console.log('Domain lookup for URN:', domainUrn);
        console.log('Domains cache size:', domainsCache.size);
        console.log('Domains cache loaded:', domainsCacheLoaded);
    }
    
    // If no domain name but we have a URN, try to get it from domains cache
    if (!domainName && domainUrn) {
        domainName = getDomainName(domainUrn);
        if (domainName) {
            console.log('Found domain name in cache:', domainName);
        } else {
            console.log('Domain name not found in cache for URN:', domainUrn);
        }
    }
    
    // Fallback to URN extraction if still no name
    if (!domainName && domainUrn) {
        const parts = domainUrn.split(':');
        domainName = parts[parts.length - 1] || domainUrn;
        console.log('Using fallback domain name:', domainName);
    }
    
    // Store product data in global store for view modal
    const storeKey = productId || urn;
    productDataStore[tabType].set(storeKey, product);
    
    // Extract tags, glossary terms, custom properties, and structured properties counts
    const tagsCount = product.tags?.tags?.length || product.globalTags?.tags?.length || 0;
    const glossaryTermsCount = product.glossaryTerms?.terms?.length || product.terms?.length || 0;
    
    // Custom properties - get from customProperties array
    const customProperties = product.customProperties || [];
    const customPropsCount = Array.isArray(customProperties) ? customProperties.length : 0;
    
    // Structured properties - get from structuredProperties.properties array
    const structuredProperties = product.structuredProperties?.properties || [];
    const structuredPropsCount = Array.isArray(structuredProperties) ? structuredProperties.length : 0;
    
    // Prepare entities display
    let entitiesDisplay = `<span class="badge bg-primary">${entityCount}</span>`;
    if (entityCount > 0 && product.entity_urns && product.entity_urns.length > 0) {
        const entityList = product.entity_urns.slice(0, 2).map(entityUrn => {
            // Extract entity name from URN for display
            const parts = entityUrn.split(',');
            const entityName = parts[parts.length - 1] || entityUrn;
            return escapeHtml(entityName);
        }).join(', ');
        
        entitiesDisplay += `<div class="mt-1"><small class="text-muted">${entityList}${entityCount > 2 ? '...' : ''}</small></div>`;
    }
    
    return `
        <tr data-product-id="${productId}" data-product-urn="${urn}">
            <td class="checkbox-column">
                <input type="checkbox" class="form-check-input product-checkbox" data-tab="${tabType}" data-product-id="${productId}">
            </td>
            <td style="max-width: 150px;">
                <div class="d-flex align-items-center">
                    <i class="${typeIcon} me-2"></i>
                    <strong class="text-truncate" title="${escapeHtml(name)}">${escapeHtml(truncateText(name, 25))}</strong>
                </div>
            </td>
            <td style="max-width: 200px;">
                <span class="text-truncate d-block" title="${escapeHtml(description)}">${escapeHtml(truncateText(description, 35))}</span>
            </td>
            <td>
                ${entitiesDisplay}
            </td>
            <td>
                ${domainName ? `<span class="badge bg-info">${escapeHtml(domainName)}</span>` : '<span class="text-muted">None</span>'}
            </td>
            <td class="text-center">
                ${tagsCount > 0 ? `<span class="badge bg-secondary">${tagsCount}</span>` : '<span class="text-muted">0</span>'}
            </td>
            <td class="text-center">
                ${glossaryTermsCount > 0 ? `<span class="badge bg-info">${glossaryTermsCount}</span>` : '<span class="text-muted">0</span>'}
            </td>
            <td class="text-center">
                ${customPropsCount > 0 ? `<span class="badge bg-secondary">${customPropsCount}</span>` : '<span class="text-muted">0</span>'}
            </td>
            <td class="text-center">
                ${structuredPropsCount > 0 ? `<span class="badge bg-success">${structuredPropsCount}</span>` : '<span class="text-muted">0</span>'}
            </td>
            <td class="text-center">
                ${product.owners_count ? `<span class="badge bg-info">${product.owners_count}</span>` : '<span class="text-muted">0</span>'}
            </td>
            ${tabType === 'synced' ? `<td><span class="badge ${statusClass}">${product.sync_status_display || product.sync_status}</span></td>` : ''}
            <td>
                <code class="small text-truncate d-block" style="max-width: 250px;" title="${escapeHtml(urn)}">${escapeHtml(truncateUrn(urn, 50))}</code>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary view-item" 
                            title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${getDataProductActionButtons(product, tabType)}
                </div>
            </td>
        </tr>
    `;
}

function getDataProductActionButtons(item, tabType) {
    const hasDataHubConnection = true; // This should come from the template context
    let buttons = '';
    
    if (tabType === 'local') {
        // 1. Edit - For local data products
        if (item.id) {
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-warning edit-product" 
                        data-product-id="${item.id}" title="Edit Data Product">
                    <i class="fas fa-edit"></i>
                </button>
            `;
            
            // 2. Sync to DataHub - Only for local-only data products
            if (hasDataHubConnection && item.sync_status === 'LOCAL_ONLY') {
                buttons += `
                    <button type="button" class="btn btn-sm btn-outline-success sync-to-datahub" 
                            data-product-id="${item.id}" title="Sync to DataHub">
                        <i class="fas fa-upload"></i>
                    </button>
                `;
            }
            
            // 4. Download JSON - Available for all
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-secondary download-json" 
                        data-product-id="${item.id}" title="Download JSON">
                    <i class="fas fa-file-download"></i>
                </button>
            `;
            
            // 5. Add to Staged Changes - Available for all
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-warning add-to-staged" 
                        data-product-id="${item.id}" title="Add to Staged Changes">
                    <i class="fab fa-github"></i>
                </button>
            `;
            
            // 6. Delete Local - For local data products
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-danger delete-local-product" 
                        data-product-id="${item.id}" title="Delete Local">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }
    } else if (tabType === 'remote') {
        // 3. Sync to Local - For remote data products
        buttons += `
            <button type="button" class="btn btn-sm btn-outline-primary sync-to-local" 
                    data-product-urn="${escapeHtml(item.urn)}" title="Sync to Local">
                <i class="fas fa-download"></i>
            </button>
        `;
        
        // 4. Download JSON - Available for all
        buttons += `
            <button type="button" class="btn btn-sm btn-outline-secondary download-json" 
                    data-product-urn="${escapeHtml(item.urn)}" title="Download JSON">
                <i class="fas fa-file-download"></i>
            </button>
        `;
        
        // 5. Add to Staged Changes - Available for all
        buttons += `
            <button type="button" class="btn btn-sm btn-outline-warning add-to-staged" 
                    data-product-urn="${escapeHtml(item.urn)}" title="Add to Staged Changes">
                <i class="fab fa-github"></i>
            </button>
        `;
        
        // 7. Delete Remote - For remote-only data products
        buttons += `
            <button type="button" class="btn btn-sm btn-outline-danger delete-remote-product" 
                    data-product-urn="${escapeHtml(item.urn)}" title="Delete from DataHub">
                <i class="fas fa-trash"></i>
            </button>
        `;
    } else if (tabType === 'synced') {
        // 1. Edit - For synced data products
        if (item.id) {
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-warning edit-product" 
                        data-product-id="${item.id}" title="Edit Data Product">
                    <i class="fas fa-edit"></i>
                </button>
            `;
            
            // 2b. Resync - For synced data products that are modified or synced
            if (item.sync_status === 'MODIFIED' || item.sync_status === 'SYNCED') {
                buttons += `
                    <button type="button" class="btn btn-sm btn-outline-info resync-product" 
                            data-product-id="${item.id}" data-product-urn="${escapeHtml(item.urn)}" title="Resync from DataHub">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                `;
            }
            
            // 2c. Push to DataHub - For synced data products that are modified
            if (item.sync_status === 'MODIFIED') {
                buttons += `
                    <button type="button" class="btn btn-sm btn-outline-success push-to-datahub" 
                            data-product-id="${item.id}" title="Push to DataHub">
                        <i class="fas fa-upload"></i>
                    </button>
                `;
            }
            
            // 4. Download JSON - Available for all
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-secondary download-json" 
                        data-product-id="${item.id}" title="Download JSON">
                    <i class="fas fa-file-download"></i>
                </button>
            `;
            
            // 5. Add to Staged Changes - Available for all
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-warning add-to-staged" 
                        data-product-id="${item.id}" title="Add to Staged Changes">
                    <i class="fab fa-github"></i>
                </button>
            `;
            
            // 6. Delete Local - For synced data products
            buttons += `
                <button type="button" class="btn btn-sm btn-outline-danger delete-local-product" 
                        data-product-id="${item.id}" title="Delete Local">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }
    }
    
    // Add DataHub link for remote items
    if (item.urn && !item.urn.includes('local:') && productsData.datahub_url) {
        buttons += `
            <a href="${getDataHubUrl(item.urn, 'product')}" 
               class="btn btn-sm btn-outline-info" 
               target="_blank" title="View in DataHub">
                <i class="fas fa-external-link-alt"></i>
            </a>
        `;
    }
    
    return buttons;
}

function attachActionButtonHandlers(content) {
    console.log('Attaching action button handlers to content:', content);
    
    // Edit data product buttons (local and synced)
    const editButtons = content.querySelectorAll('.edit-product');
    console.log('Found edit-product buttons:', editButtons.length);
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            console.log('Edit button clicked for product ID:', productId);
            editDataProduct(productId);
        });
    });

    // Push to DataHub buttons
    const pushButtons = content.querySelectorAll('.push-product');
    console.log('Found push-product buttons:', pushButtons.length);
    pushButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            console.log('Push button clicked for product ID:', productId);
            pushDataProductToDataHub(productId, this);
        });
    });

    // Sync to local buttons
    const syncButtons = content.querySelectorAll('.sync-to-local');
    console.log('Found sync-to-local buttons:', syncButtons.length);
    syncButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productUrn = this.dataset.productUrn;
            console.log('Sync button clicked for product URN:', productUrn);
            syncDataProductToLocal(productUrn, this);
        });
    });

    // Resync buttons
    const resyncButtons = content.querySelectorAll('.resync-product');
    console.log('Found resync-product buttons:', resyncButtons.length);
    resyncButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productUrn = this.dataset.productUrn;
            console.log('Resync button clicked for product ID:', productId, 'URN:', productUrn);
            resyncDataProduct(productId, productUrn, this);
        });
    });

    // Delete local data product buttons
    const deleteLocalButtons = content.querySelectorAll('.delete-local-product');
    console.log('Found delete-local-product buttons:', deleteLocalButtons.length);
    deleteLocalButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            console.log('Delete local button clicked for product ID:', productId);
            deleteLocalDataProduct(productId, this);
        });
    });

    // Add to PR buttons
    const addToPrButtons = content.querySelectorAll('.add-to-pr');
    console.log('Found add-to-pr buttons:', addToPrButtons.length);
    addToPrButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productUrn = this.dataset.productUrn;
            const productId = this.dataset.productId;
            console.log('Add to PR button clicked for product URN:', productUrn, 'ID:', productId);
            addDataProductToPR(productUrn, productId, this);
        });
    });

    // Edit remote data product buttons
    const editRemoteButtons = content.querySelectorAll('.edit-remote-product');
    console.log('Found edit-remote-product buttons:', editRemoteButtons.length);
    editRemoteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productUrn = this.dataset.productUrn;
            console.log('Edit remote button clicked for product URN:', productUrn);
            editRemoteDataProduct(productUrn, this);
        });
    });

    // Delete remote data product buttons
    const deleteRemoteButtons = content.querySelectorAll('.delete-remote-product');
    console.log('Found delete-remote-product buttons:', deleteRemoteButtons.length);
    deleteRemoteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productUrn = this.dataset.productUrn;
            console.log('Delete remote button clicked for product URN:', productUrn);
            deleteRemoteDataProduct(productUrn, this);
        });
    });
}

// Action button functions
function editDataProduct(productId) {
    window.location.href = `/metadata/data-products/${productId}/`;
}

function pushDataProductToDataHub(productId, button) {
    if (!confirm('Are you sure you want to push this data product to DataHub?')) {
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/metadata/data-products/${productId}/push-to-datahub/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Data product pushed to DataHub successfully!`);
            // Reload data to refresh status
            loadProductsData();
        } else {
            showError('Failed to push data product to DataHub: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error pushing data product to DataHub:', error);
        showError('Error pushing data product to DataHub');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function syncDataProductToLocal(productUrn, button) {
    if (!confirm('Are you sure you want to sync this data product to local storage?')) {
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/metadata/data-products/sync-to-local/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            'product_urn': productUrn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Data product synced to local successfully!`);
            
            // Immediately update the UI instead of full reload
            moveDataProductToSynced(productUrn, button, data);
            
        } else {
            showError('Failed to sync data product to local: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error syncing data product to local:', error);
        showError('Error syncing data product to local');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function moveDataProductToSynced(productUrn, button, data) {
    // Find the data product row in the remote-only tab
    const remoteRow = button.closest('tr');
    if (!remoteRow) return;
    
    // Get the data product data from the row
    const cells = remoteRow.querySelectorAll('td');
    if (cells.length < 6) return;
    
    const name = cells[1].textContent.trim();
    const description = cells[2].textContent.trim();
    const entities = cells[3].innerHTML; // Keep HTML for badges
    const owners = cells[4].innerHTML; // Keep HTML for badges
    
    // Get the synced data from the API response or construct it
    const syncedProduct = {
        id: data.product_id || null, // This should come from the sync response
        urn: productUrn,
        properties: {
            name: name,
            description: description
        },
        name: name,
        description: description,
        sync_status: 'SYNCED',
        sync_status_display: 'Synced',
        entities_count: 0, // Could be extracted from entities HTML
        owners_count: 0,   // Could be extracted from owners HTML
        entity_urns: [],
        ownership: { owners: [] }
    };
    
    // Create new synced row using the same structure as renderProductRow
    const syncedRowHtml = renderProductRow(syncedProduct, 'synced');
    
    // Remove from remote-only tab
    remoteRow.remove();
    
    // Add to synced tab
    const syncedTableBody = document.querySelector('#synced-tab-pane tbody');
    if (syncedTableBody) {
        syncedTableBody.insertAdjacentHTML('beforeend', syncedRowHtml);
        
        // Attach event handlers to the newly added row
        const newRow = syncedTableBody.lastElementChild;
        if (newRow) {
            attachActionButtonHandlers(newRow);
            
            // Attach view button handler
            const viewButton = newRow.querySelector('.view-item');
            if (viewButton) {
                viewButton.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const productId = row.dataset.productId;
                    const productUrn = row.dataset.productUrn;
                    const storeKey = productId || productUrn;
                    
                    // Find the product data in the appropriate store
                    let itemData = null;
                    for (const [tabType, store] of Object.entries(productDataStore)) {
                        if (store.has(storeKey)) {
                            itemData = store.get(storeKey);
                            break;
                        }
                    }
                    
                    if (itemData) {
                        showProductDetails(itemData);
                    } else {
                        console.error('Product data not found in store for key:', storeKey);
                        showError('Unable to load product details');
                    }
                });
            }
        }
    }
    
    // Update statistics immediately
    updateStatisticsAfterSync();
    
    // Update tab counts in the nav
    updateTabCounts();
    
    // If we're currently viewing the synced tab, make sure the new row is visible
    if (currentTab === 'synced') {
        // Re-apply current filters and pagination to the synced tab
        displayTabContent('synced');
    }
}

function resyncDataProduct(productId, productUrn, button) {
    if (!confirm('Are you sure you want to resync this data product?')) {
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/metadata/data-products/${productId}/resync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            'product_urn': productUrn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Data product resynced successfully!`);
            // Reload data to refresh status
            loadProductsData();
        } else {
            showError('Failed to resync data product: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error resyncing data product:', error);
        showError('Error resyncing data product');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function deleteLocalDataProduct(productId, button) {
    if (!confirm('Are you sure you want to delete this local data product? This action cannot be undone.')) {
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/metadata/data-products/${productId}/delete/`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Data product deleted successfully!`);
            // Reload data to refresh list
            loadProductsData();
        } else {
            showError('Failed to delete data product: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting data product:', error);
        showError('Error deleting data product');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function deleteRemoteDataProduct(productUrn, button) {
    if (!confirm('Are you sure you want to delete this remote data product? This action cannot be undone.')) {
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/metadata/data-products/delete-remote/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            'product_urn': productUrn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Remote data product deleted successfully!`);
            // Reload data to refresh list
            loadProductsData();
        } else {
            showError('Failed to delete remote data product: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting remote data product:', error);
        showError('Error deleting remote data product');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function addDataProductToPR(productUrn, productId, button) {
    const id = productId || productUrn;
    
    if (!id) {
        showError('No data product ID or URN provided');
        return;
    }
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Determine the endpoint based on whether we have a productId (local) or productUrn (remote)
    let endpoint;
    let body;
    
    if (productId) {
        // Local data product
        endpoint = `/metadata/data-products/${productId}/add-to-pr/`;
        body = JSON.stringify({});
    } else {
        // Remote data product
        endpoint = '/metadata/data-products/add-remote-to-pr/';
        body = JSON.stringify({ 'product_urn': productUrn });
    }
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: body
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Data product added to PR successfully!<br>
                        <strong>File:</strong> ${data.file_path || 'Generated'}<br>
                        <strong>Environment:</strong> ${data.environment || 'Default'}`);
        } else {
            showError('Failed to add data product to PR: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error adding data product to PR:', error);
        showError('Error adding data product to PR');
    })
    .finally(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function editRemoteDataProduct(productUrn, button) {
    // Show detailed data product information for editing (read-only for now)
    console.log('Showing details for remote data product:', productUrn);
    
    // Find the data product data in our local cache
    const productData = productsData.remote_only_items.find(item => item.urn === productUrn);
    
    if (productData) {
        showProductDetails(productData);
    } else {
        showError('Data product details not found. Please refresh the page and try again.');
    }
}

function updateStatisticsAfterSync() {
    // Update statistics by decrementing remote-only and incrementing synced
    const remoteOnlyCard = document.querySelector('.statistics-card[data-status="REMOTE_ONLY"] .stat-value');
    const syncedCard = document.querySelector('.statistics-card[data-status="SYNCED"] .stat-value');
    
    if (remoteOnlyCard) {
        const currentRemoteCount = parseInt(remoteOnlyCard.textContent) || 0;
        remoteOnlyCard.textContent = Math.max(0, currentRemoteCount - 1);
    }
    
    if (syncedCard) {
        const currentSyncedCount = parseInt(syncedCard.textContent) || 0;
        syncedCard.textContent = currentSyncedCount + 1;
    }
}

function updateTabCounts() {
    // Update tab navigation counts
    const remoteTab = document.querySelector('button[data-bs-target="#remote-only-tab-pane"] .badge');
    const syncedTab = document.querySelector('button[data-bs-target="#synced-tab-pane"] .badge');
    
    if (remoteTab) {
        const currentRemoteCount = parseInt(remoteTab.textContent) || 0;
        remoteTab.textContent = Math.max(0, currentRemoteCount - 1);
    }
    
    if (syncedTab) {
        const currentSyncedCount = parseInt(syncedTab.textContent) || 0;
        syncedTab.textContent = currentSyncedCount + 1;
    }
}

// Modal functions for create and edit data products
function editDataProduct(productId) {
    console.log('Editing data product:', productId);
    
    // Find the product data
    const productData = [...(productsData.synced_items || []), ...(productsData.local_only_items || [])]
        .find(item => (item.combined?.id || item.id) === productId);
    
    if (!productData) {
        showError('Data product not found');
        return;
    }
    
    const product = productData.combined || productData;
    
    // Populate the edit form
    document.getElementById('edit-product-id').value = productId;
    document.getElementById('edit-product-name').value = product.properties?.name || product.name || '';
    document.getElementById('edit-product-description').value = product.properties?.description || product.description || '';
    document.getElementById('edit-product-domain').value = product.domain_urn || '';
    document.getElementById('edit-product-external-url').value = product.properties?.externalUrl || product.external_url || '';
    
    // Load ownership data
    loadOwnershipData('edit-ownership-sections-container', product.ownership);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editDataProductModal'));
    modal.show();
}

function loadOwnershipData(containerId, ownershipData) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (ownershipData && ownershipData.owners && ownershipData.owners.length > 0) {
        ownershipData.owners.forEach((owner, index) => {
            addOwnershipSectionToModal(containerId, owner, index);
        });
    }
}

function addOwnershipSectionToModal(containerId, ownerData = null, index = null) {
    const container = document.getElementById(containerId);
    const sectionId = `ownership-section-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    const sectionHtml = `
        <div class="ownership-section mb-3 border rounded p-3" id="${sectionId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Owner ${container.children.length + 1}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-ownership-section" onclick="removeOwnershipSection('${sectionId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Owner Type</label>
                    <select class="form-select ownership-type" name="ownership_type[]">
                        <option value="TECHNICAL_OWNER" ${ownerData?.type === 'TECHNICAL_OWNER' ? 'selected' : ''}>Technical Owner</option>
                        <option value="BUSINESS_OWNER" ${ownerData?.type === 'BUSINESS_OWNER' ? 'selected' : ''}>Business Owner</option>
                        <option value="DATA_STEWARD" ${ownerData?.type === 'DATA_STEWARD' ? 'selected' : ''}>Data Steward</option>
                        <option value="NONE" ${ownerData?.type === 'NONE' ? 'selected' : ''}>None</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Owner</label>
                    <select class="form-select ownership-owner" name="ownership_owner[]" multiple>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', sectionHtml);
    
    // Initialize Select2 for the new owner select
    const ownerSelect = container.querySelector(`#${sectionId} .ownership-owner`);
    if (ownerSelect && window.jQuery) {
        $(ownerSelect).select2({
            placeholder: 'Select owners...',
            allowClear: true,
            width: '100%'
        });
        
        // Set selected values if provided
        if (ownerData && ownerData.owner) {
            if (ownerData.owner.urn) {
                $(ownerSelect).append(new Option(ownerData.owner.urn, ownerData.owner.urn, true, true));
            }
        }
    }
}

function removeOwnershipSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.remove();
        updateOwnershipSectionNumbers();
    }
}

function updateOwnershipSectionNumbers() {
    document.querySelectorAll('.ownership-section h6').forEach((header, index) => {
        header.textContent = `Owner ${index + 1}`;
    });
}

// Form submission handlers
document.addEventListener('DOMContentLoaded', function() {
    // Create form handler
    const createForm = document.getElementById('data-product-form');
    if (createForm) {
        createForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/metadata/data-products/create/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showDataProductNotification('success', 'Data product created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createDataProductModal')).hide();
                    loadProductsData();
                    createForm.reset();
                } else {
                    showDataProductNotification('error', 'Failed to create data product: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating data product:', error);
                showDataProductNotification('error', 'Error creating data product');
            });
        });
    }
    
    // Edit form handler
    const editForm = document.getElementById('edit-data-product-form');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = formData.get('product_id');
            
            fetch(`/metadata/data-products/${productId}/edit/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showDataProductNotification('success', 'Data product updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editDataProductModal')).hide();
                    loadProductsData();
                } else {
                    showDataProductNotification('error', 'Failed to update data product: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error updating data product:', error);
                showDataProductNotification('error', 'Error updating data product');
            });
        });
    }
    
    // Add ownership section handlers
    document.getElementById('add-ownership-section')?.addEventListener('click', function() {
        addOwnershipSectionToModal('ownership-sections-container');
    });
    
    document.getElementById('edit-add-ownership-section')?.addEventListener('click', function() {
        addOwnershipSectionToModal('edit-ownership-sections-container');
    });
    
    // Load users and groups for ownership sections
    loadUsersAndGroups();
    
    // Ensure domains are populated when modals are shown
    document.getElementById('createDataProductModal')?.addEventListener('shown.bs.modal', function() {
        populateDomainDropdowns();
    });
    
    document.getElementById('editDataProductModal')?.addEventListener('shown.bs.modal', function() {
        populateDomainDropdowns();
    });
});

// Ownership section functions (similar to tags page)
function addOwnershipSectionToModal(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container ${containerId} not found`);
        return;
    }
    
    const sectionId = `ownership-section-${Date.now()}`;
    const sectionHTML = `
        <div class="card mb-3" id="${sectionId}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-crown me-2 text-primary"></i>
                    Ownership Section
                </h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOwnershipSection('${sectionId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Owners <span class="text-danger">*</span></label>
                    <select class="form-select owners-select" name="owners[]" multiple required>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="form-text">Search and select multiple owners</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ownership Type <span class="text-danger">*</span></label>
                    <select class="form-select ownership-type-select" name="ownership_types[]" required>
                        <option value="">Select ownership type...</option>
                    </select>
                    <div class="form-text">Select the ownership type for these owners</div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', sectionHTML);
    
    // Initialize Select2 for the new section with a small delay to ensure DOM is ready
    setTimeout(() => {
        try {
            const newSection = document.getElementById(sectionId);
            if (newSection) {
                const ownershipTypeSelect = newSection.querySelector('.ownership-type-select');
                const ownersSelect = newSection.querySelector('.owners-select');
                
                if (ownershipTypeSelect && ownersSelect) {
                    // Populate ownership types
                    populateOwnershipTypeSelect(ownershipTypeSelect);
                    
                    // Populate owners
                    populateOwnersSelect(ownersSelect);
                    
                    // Initialize Select2 for the owners dropdown
                    if (typeof $ !== 'undefined' && $.fn.select2) {
                        $(ownersSelect).select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            placeholder: 'Search and select owners...',
                            allowClear: true,
                            dropdownParent: $(newSection)
                        });
                        console.log('Select2 initialized successfully for owners select');
                    } else {
                        console.error('Select2 not available');
                    }
                } else {
                    console.error('Select elements not found in new section');
                }
            } else {
                console.error(`New section ${sectionId} not found after insertion`);
            }
        } catch (error) {
            console.error('Error initializing Select2:', error);
        }
    }, 10);
}

function removeOwnershipSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.remove();
    }
}

function populateOwnershipTypeSelect(select) {
    if (!select || !usersAndGroupsCache.ownership_types) return;
    
    // Clear existing options except the first one
    select.innerHTML = '<option value="">Select ownership type</option>';
    
    usersAndGroupsCache.ownership_types.forEach(type => {
        const option = document.createElement('option');
        option.value = type.urn;
        option.textContent = type.info?.name || type.name || type.urn;
        select.appendChild(option);
    });
}

function populateOwnersSelect(select) {
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '';
    
    // Add users
    if (usersAndGroupsCache.users) {
        usersAndGroupsCache.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.urn;
            option.textContent = user.info?.displayName || user.username || user.urn;
            option.dataset.type = 'user';
            select.appendChild(option);
        });
    }
    
    // Add groups
    if (usersAndGroupsCache.groups) {
        usersAndGroupsCache.groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.urn;
            option.textContent = group.info?.displayName || group.name || group.urn;
            option.dataset.type = 'group';
            select.appendChild(option);
        });
    }
}

// Global cache for users and groups is already declared in the external JS file

// Global data store for product details (to avoid JSON parsing issues)
    let productDataStore = {
        synced: new Map(),
        local: new Map(),
        remote: new Map()
    };
    
    // Domains cache for name lookups
    // Global cache for domains and glossary terms
    let domainsCache = new Map();
    let glossaryTermsCache = new Map();
    let domainsCacheLoaded = false;
    
    // Load domains data for name lookups
    async function loadDomainsForLookup() {
        if (domainsCacheLoaded) return;
        
        try {
            const response = await fetch('/metadata/domains/data/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const allDomains = [
                    ...(data.data.synced_items || []),
                    ...(data.data.local_only_items || []),
                    ...(data.data.remote_only_items || [])
                ];
                
                // Build cache map
                allDomains.forEach(domain => {
                    if (domain.urn) {
                        const name = domain.properties?.name || domain.name || '';
                        domainsCache.set(domain.urn, name);
                    }
                });
                
                domainsCacheLoaded = true;
                console.log(`Loaded ${domainsCache.size} domains for lookup`);
                
                // Debug: log some domain entries
                if (domainsCache.size > 0) {
                    const firstFew = Array.from(domainsCache.entries()).slice(0, 3);
                    console.log('Sample domains:', firstFew);
                }
                
                // Populate domain dropdowns after loading
                populateDomainDropdowns();
            }
        } catch (error) {
            console.error('Error loading domains for lookup:', error);
        }
    }
    
    // Get domain name from cache
    function getDomainName(domainUrn) {
        if (!domainUrn) return '';
        return domainsCache.get(domainUrn) || '';
    }
    
    // Populate domain dropdowns with loaded data
    function populateDomainDropdowns() {
        const domainSelects = [
            document.getElementById('product-domain'),
            document.getElementById('edit-product-domain')
        ];
        
        domainSelects.forEach(select => {
            if (!select) return;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Select a domain (optional)</option>';
            
            // Add domains from cache
            domainsCache.forEach((name, urn) => {
                const option = document.createElement('option');
                option.value = urn;
                option.textContent = name || urn;
                select.appendChild(option);
            });
        });
        
        console.log('Domain dropdowns populated with', domainsCache.size, 'domains');
    }
    
    // Notification system (matching tags page)
    function showDataProductNotification(type, message) {
        // Check if we have notifications container
        let container = document.getElementById('notifications-container');
        
        // Create it if it doesn't exist
        if (!container) {
            container = document.createElement('div');
            container.id = 'notifications-container';
            container.className = 'position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '1050';
            document.body.appendChild(container);
        }
        
        // Create unique ID
        const id = 'toast-' + Date.now();
        
        // Create toast HTML
        let bgClass, icon, title;
        
        if (type === 'success') {
            bgClass = 'bg-success';
            icon = 'fa-check-circle';
            title = 'Success';
        } else if (type === 'info') {
            bgClass = 'bg-info';
            icon = 'fa-info-circle';
            title = 'Info';
        } else {
            bgClass = 'bg-danger';
            icon = 'fa-exclamation-circle';
            title = 'Error';
        }
        
        const toast = document.createElement('div');
        toast.className = `toast ${bgClass} text-white`;
        toast.id = id;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="toast-header ${bgClass} text-white">
                <i class="fas ${icon} me-2"></i>
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">${message}</div>
        `;
        
        container.appendChild(toast);
        
        // Initialize and show the toast
        const toastInstance = new bootstrap.Toast(toast, {
            delay: 5000
        });
        toastInstance.show();
        
        // Remove toast from DOM after it's hidden
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }

    // Load glossary terms data for name lookups
    async function loadGlossaryTermsForLookup() {
        if (glossaryTermsCache.size > 0) return; // Already loaded
        
        try {
            const response = await fetch('/metadata/glossary/data/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const allTerms = [
                    ...(data.data.synced_items || []),
                    ...(data.data.local_only_items || []),
                    ...(data.data.remote_only_items || [])
                ];
                
                // Build cache map
                allTerms.forEach(term => {
                    if (term.urn) {
                        const name = term.properties?.name || term.name || '';
                        glossaryTermsCache.set(term.urn, name);
                    }
                });
                
                console.log(`Loaded ${glossaryTermsCache.size} glossary terms for lookup`);
            }
        } catch (error) {
            console.error('Error loading glossary terms for lookup:', error);
        }
    }
    
    // Get glossary term name from cache
    function getGlossaryTermName(termUrn) {
        if (!termUrn) return '';
        return glossaryTermsCache.get(termUrn) || '';
    }

// Load users and groups from the server
async function loadUsersAndGroups() {
    try {
        const response = await fetch('/metadata/api/users-groups/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            usersAndGroupsCache.users = data.users || [];
            usersAndGroupsCache.groups = data.groups || [];
            usersAndGroupsCache.ownership_types = data.ownership_types || [];
            console.log('Loaded users and groups:', data);
        } else {
            console.error('Failed to load users and groups');
        }
    } catch (error) {
        console.error('Error loading users and groups:', error);
    }
}

// This will be called from the main DOMContentLoaded handler

// Global bulk action functions - matching tags page style
function resyncAllProducts() {
    if (confirm('Are you sure you want to resync all data products? This may take some time.')) {
        showDataProductNotification('success', 'Resync all initiated - this functionality will be implemented soon');
    }
}

function exportAllProducts() {
    showDataProductNotification('success', 'Export all initiated - downloading data products...');
    // TODO: Implement actual export functionality
}

function addAllProductsToStagedChanges() {
    if (confirm('Are you sure you want to add all data products to staged changes?')) {
        showDataProductNotification('success', 'All data products added to staged changes');
    }
}

function showImportProductsModal() {
    // TODO: Show import modal similar to tags page
    showDataProductNotification('info', 'Import modal functionality will be implemented soon');
}
</script>

<!-- Create Data Product Modal -->
<div class="modal fade" id="createDataProductModal" tabindex="-1" aria-labelledby="createDataProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createDataProductModalLabel">Create New Data Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="data-product-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="product-name" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="product-name" name="name" required>
                        <div class="form-text">Data product name should be unique and descriptive</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="product-description" class="form-label">Description</label>
                        <textarea class="form-control" id="product-description" name="description" rows="3"></textarea>
                        <div class="form-text">Optional description for the data product</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="product-domain" class="form-label">Domain</label>
                        <select class="form-select" id="product-domain" name="domain_urn">
                            <option value="">Select a domain (optional)</option>
                            <!-- Domain options will be populated dynamically -->
                        </select>
                        <div class="form-text">Associate this data product with a domain</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="product-external-url" class="form-label">External URL</label>
                        <input type="url" class="form-control" id="product-external-url" name="external_url">
                        <div class="form-text">Optional external URL for documentation or more information</div>
                    </div>
                    
                    <div class="mb-3" id="ownership-section">
                        <label class="form-label fw-bold">Ownership</label>
                        <div id="ownership-sections-container">
                            <!-- Ownership sections will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-ownership-section">
                            <i class="fas fa-plus me-1"></i> Add Ownership Section
                        </button>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            You can add multiple ownership sections with different ownership types
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Data Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Data Product Modal -->
<div class="modal fade" id="editDataProductModal" tabindex="-1" aria-labelledby="editDataProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDataProductModalLabel">Edit Data Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="edit-data-product-form">
                {% csrf_token %}
                <input type="hidden" id="edit-product-id" name="product_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-product-name" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit-product-name" name="name" required>
                        <div class="form-text">Data product name should be unique and descriptive</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-product-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-product-description" name="description" rows="3"></textarea>
                        <div class="form-text">Optional description for the data product</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-product-domain" class="form-label">Domain</label>
                        <select class="form-select" id="edit-product-domain" name="domain_urn">
                            <option value="">Select a domain (optional)</option>
                            <!-- Domain options will be populated dynamically -->
                        </select>
                        <div class="form-text">Associate this data product with a domain</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-product-external-url" class="form-label">External URL</label>
                        <input type="url" class="form-control" id="edit-product-external-url" name="external_url">
                        <div class="form-text">Optional external URL for documentation or more information</div>
                    </div>
                    
                    <div class="mb-3" id="edit-ownership-section">
                        <label class="form-label fw-bold">Ownership</label>
                        <div id="edit-ownership-sections-container">
                            <!-- Ownership sections will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="edit-add-ownership-section">
                            <i class="fas fa-plus me-1"></i> Add Ownership Section
                        </button>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            You can add multiple ownership sections with different ownership types
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Data Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %} 